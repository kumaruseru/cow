<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ - Cow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            overflow-x: hidden;
            visibility: hidden; /* Ẩn body cho đến khi kiểm tra xong */
        }
        
        /* Chỉ hiển thị khi đã đăng nhập */
        body.authenticated {
            visibility: visible;
        }
        
        /* User name styling cho xuống dòng */
        #user-name {
            line-height: 1.2;
            font-size: 1.125rem; /* text-lg equivalent */
            max-width: 160px;
        }
        
        /* --- TÙY CHỈNH THANH CUỘN --- */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Drag & Drop Styles */
        .drag-over {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.02);
        }
        
        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview-item .remove-image {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .image-preview-item .remove-image:hover {
            background: rgba(239, 68, 68, 0.8);
        }
        
        /* Location Styles */
        .location-result-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .location-result-item:hover {
            background-color: #f3f4f6;
        }
        
        .location-result-item:last-child {
            border-bottom: none;
        }

        /* Hiệu ứng cho nút like */
        .like-button.liked svg {
            fill: #ef4444;
            stroke: #ef4444;
            transform: scale(1.1);
        }
        .like-button svg {
            transition: all 0.2s ease-in-out;
        }

        /* Keyframes cho hiệu ứng xuất hiện */
        @keyframes fadeIn-Up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeIn-Up 0.6s ease-out forwards;
        }
        
        /* Transition cho menu tùy chọn */
        .post-options-menu {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header chính -->
    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40">
        <div class="relative flex items-center justify-between h-16 px-4">
            <!-- Cột Trái: Logo và Thanh tìm kiếm -->
            <div class="flex items-center space-x-2">
                <div class="flex-shrink-0">
                    <a href="/" class="block" title="Về trang chủ">
                        <svg class="w-10 h-10 text-black hover:text-gray-700 transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2.5 13.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-5H8v-2h8v2z"/><path d="M19.36 8.64C18.48 7.52 17.3 6.66 16 6.18V4.05c1.73.64 3.22 1.76 4.36 3.14l-1 1.45zM4.64 8.64l-1-1.45C4.78 5.81 6.27 4.69 8 4.05v2.13c-1.3.48-2.48 1.34-3.36 2.46z"/><path d="M12 18c-2.21 0-4-1.79-4-4h8c0 2.21-1.79 4-4 4z" opacity=".5"/></svg>
                    </a>
                </div>
                <div class="relative hidden lg:block">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                    </span>
                    <input 
                        id="header-search" 
                        type="search" 
                        placeholder="Tìm kiếm bạn bè..." 
                        class="w-full pl-10 pr-4 py-2 rounded-full bg-gray-100 border-transparent focus:bg-white focus:border-gray-300 focus:ring-black/50 transition"
                        autocomplete="off"
                    >
                    <!-- Dropdown kết quả tìm kiếm -->
                    <div id="search-dropdown" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-lg border border-gray-200 max-h-80 overflow-y-auto z-50 hidden">
                        <div id="search-results" class="p-2">
                            <!-- Kết quả tìm kiếm sẽ được hiển thị ở đây -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cột Giữa: Navigation Icons (định vị tuyệt đối) -->
            <nav class="hidden md:flex items-center justify-center space-x-2 absolute left-1/2 -translate-x-1/2">
                <a href="/" class="p-3 rounded-full bg-gray-200 transition" title="Trang chủ"><i data-lucide="home" class="w-6 h-6"></i></a>
                <a href="/messages" class="p-3 rounded-full hover:bg-gray-100 transition" title="Tin nhắn"><i data-lucide="message-square" class="w-6 h-6"></i></a>
                <a href="/notifications" class="p-3 rounded-full hover:bg-gray-100 transition relative" title="Thông báo">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                    <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </a>
                <a href="/friends" class="p-3 rounded-full hover:bg-gray-100 transition" title="Bạn bè"><i data-lucide="users" class="w-6 h-6"></i></a>
                <a href="/profile" class="p-3 rounded-full hover:bg-gray-100 transition" title="Profile"><i data-lucide="user" class="w-6 h-6"></i></a>
            </nav>
            <!-- Cột Phải: User Profile -->
            <div class="flex items-center space-x-3">
                <!-- Nội dung đã được xóa -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-12 gap-6">

            <!-- Left Sidebar -->
            <aside class="hidden md:block col-span-3 animate-fade-in-up" style="animation-delay: 100ms;">
                <div class="sticky top-24 space-y-6">
                    <div class="bg-white p-4 rounded-2xl shadow-lg">
                        <div class="flex items-center space-x-4">
                            <img id="user-avatar" src="https://placehold.co/56x56/000000/FFFFFF?text=B" alt="User Avatar" class="w-14 h-14 rounded-full">
                            <div class="flex-1 min-w-0">
                                <h3 id="user-name" class="font-bold text-lg break-words leading-tight">Bò Sữa</h3>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg">
                        <nav class="space-y-2">
                            <a href="/profile" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 font-semibold"><i data-lucide="user-circle" class="w-6 h-6 text-gray-600"></i><span>Hồ sơ</span></a>
                            <a href="#" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 font-semibold"><i data-lucide="newspaper" class="w-6 h-6 text-gray-600"></i><span>Bảng tin</span></a>
                            <a href="/settings" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 font-semibold"><i data-lucide="settings" class="w-6 h-6 text-gray-600"></i><span>Cài đặt</span></a>
                            <button id="logout-btn" class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 font-semibold text-left transition"><i data-lucide="log-out" class="w-6 h-6 text-gray-600"></i><span>Đăng xuất</span></button>
                        </nav>
                    </div>
                </div>
            </aside>

            <!-- Center Feed -->
            <!-- Main Content -->
            <div class="col-span-12 md:col-span-6 space-y-6 animate-fade-in-up" style="animation-delay: 200ms;">
                <!-- Create Post -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <div class="flex items-center space-x-4">
                        <img id="post-user-avatar" src="https://placehold.co/48x48/000000/FFFFFF?text=B" alt="User Avatar" class="w-12 h-12 rounded-full">
                        <div id="post-placeholder" class="flex-grow text-left px-4 py-3 bg-gray-100 rounded-full text-gray-500 cursor-pointer hover:bg-gray-200 transition">Bạn đang nghĩ gì?</div>
                    </div>
                    <div class="flex justify-around items-center mt-4 pt-4 border-t border-gray-100">
                        <button class="flex items-center space-x-2 text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg transition">
                            <i data-lucide="video" class="w-6 h-6 text-red-500"></i>
                            <span class="font-semibold">Video trực tiếp</span>
                        </button>
                        <button class="flex items-center space-x-2 text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg transition">
                            <i data-lucide="image" class="w-6 h-6 text-green-500"></i>
                            <span class="font-semibold">Ảnh/video</span>
                        </button>
                        <button class="flex items-center space-x-2 text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg transition">
                            <i data-lucide="smile" class="w-6 h-6 text-yellow-500"></i>
                            <span class="font-semibold">Cảm xúc</span>
                        </button>
                    </div>
                </div>

                <!-- Posts Feed -->
                <div id="posts-feed" class="space-y-6">
                    <!-- Bài viết sẽ được load động từ API -->
                    <div id="empty-posts" class="text-center py-12">
                        <i data-lucide="message-circle" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Chưa có bài viết nào</h3>
                        <p class="text-gray-500">Hãy tạo bài viết đầu tiên để bắt đầu chia sẻ!</p>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <aside class="hidden lg:block col-span-3 animate-fade-in-up" style="animation-delay: 300ms;">
                <div class="sticky top-24 space-y-6">
                    <div class="bg-white p-4 rounded-2xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4">Gợi ý cho bạn</h3>
                        <div id="friend-suggestions" class="space-y-4">
                            <!-- Gợi ý bạn bè sẽ được load từ API -->
                            <div class="text-center py-4 text-gray-500">
                                <i data-lucide="users" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm">Chưa có gợi ý bạn bè</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4">Thịnh hành</h3>
                        <div id="trending-topics" class="space-y-3">
                            <!-- Hashtag thịnh hành sẽ được load từ API -->
                            <div class="text-center py-4 text-gray-500">
                                <i data-lucide="trending-up" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm">Chưa có chủ đề thịnh hành</p>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

        </div>
    </main>

    <!-- Modal Tạo bài viết -->
    <div id="create-post-modal" class="fixed inset-0 z-[9999] hidden items-center justify-center" style="background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">Tạo bài viết</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div class="p-4">
                <!-- User Info -->
                <div class="flex items-center space-x-3 mb-4">
                    <img id="modal-user-avatar" src="https://placehold.co/48x48/000000/FFFFFF?text=B" alt="User Avatar" class="w-12 h-12 rounded-full">
                    <div>
                        <h3 id="modal-user-name" class="font-semibold text-gray-800">Nghia Trong</h3>
                        <select class="text-sm text-gray-600 bg-gray-100 rounded px-2 py-1" title="Quyền riêng tư">
                            <option>🌐 Công khai</option>
                            <option>👥 Bạn bè</option>
                            <option>🔒 Chỉ mình tôi</option>
                        </select>
                    </div>
                </div>
                
                <!-- Post Content -->
                <textarea id="modal-post-content" class="w-full p-3 border-0 resize-none text-lg placeholder-gray-500 focus:outline-none" 
                    placeholder="Bạn đang nghĩ gì?" rows="6"></textarea>
                
                <!-- Image Upload Section -->
                <div id="image-upload-section" class="hidden mt-4">
                    <!-- Drag & Drop Zone -->
                    <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-colors hover:border-blue-400 hover:bg-blue-50">
                        <div class="flex flex-col items-center">
                            <i data-lucide="image" class="w-12 h-12 text-gray-400 mb-3"></i>
                            <p class="text-lg font-medium text-gray-700 mb-2">Kéo thả ảnh vào đây</p>
                            <p class="text-sm text-gray-500 mb-4">hoặc</p>
                            <button type="button" id="select-image-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                Chọn ảnh từ máy tính
                            </button>
                            <input type="file" id="image-input" accept="image/*" multiple class="hidden">
                            <p class="text-xs text-gray-400 mt-2">Hỗ trợ: JPG, PNG, GIF (tối đa 10MB mỗi ảnh)</p>
                        </div>
                    </div>
                    
                    <!-- Image Preview Container -->
                    <div id="image-preview" class="mt-4 grid grid-cols-2 gap-2 hidden">
                        <!-- Preview images will be inserted here -->
                    </div>
                </div>
                
                <!-- Location Section -->
                <div id="location-section" class="hidden mt-4">
                    <div class="border border-gray-300 rounded-lg p-4">
                        <div class="flex items-center mb-3">
                            <i data-lucide="map-pin" class="w-5 h-5 text-red-500 mr-2"></i>
                            <h3 class="font-semibold text-gray-700">Thêm vị trí</h3>
                        </div>
                        
                        <!-- Location Search -->
                        <div class="relative mb-3">
                            <input type="text" id="location-search" placeholder="Tìm kiếm vị trí..." 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" id="get-current-location" class="absolute right-2 top-2 p-1 text-gray-500 hover:text-blue-500 transition" title="Lấy vị trí hiện tại">
                                <i data-lucide="navigation" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <!-- Location Results -->
                        <div id="location-results" class="hidden max-h-40 overflow-y-auto">
                            <!-- Search results will appear here -->
                        </div>
                        
                        <!-- Selected Location Display -->
                        <div id="selected-location" class="hidden p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i data-lucide="map-pin" class="w-4 h-4 text-red-500 mr-2"></i>
                                    <span id="selected-location-text" class="text-sm font-medium text-gray-700"></span>
                                </div>
                                <button type="button" id="remove-location" class="text-gray-400 hover:text-red-500 transition">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex items-center justify-between mt-4 p-3 border border-gray-200 rounded-lg">
                    <span class="text-sm font-semibold text-gray-700">Thêm vào bài viết của bạn</span>
                    <div class="flex items-center space-x-2">
                        <button id="toggle-image-upload" class="p-2 hover:bg-gray-100 rounded-full transition" title="Ảnh/Video">
                            <i data-lucide="image" class="w-6 h-6 text-green-500"></i>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="Gắn thẻ bạn bè">
                            <i data-lucide="users" class="w-6 h-6 text-blue-500"></i>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="Cảm xúc">
                            <i data-lucide="smile" class="w-6 h-6 text-yellow-500"></i>
                        </button>
                        <button id="toggle-location" class="p-2 hover:bg-gray-100 rounded-full transition" title="Vị trí">
                            <i data-lucide="map-pin" class="w-6 h-6 text-red-500"></i>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="GIF">
                            <span class="text-sm font-bold text-purple-500">GIF</span>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="Thêm">
                            <i data-lucide="more-horizontal" class="w-6 h-6 text-gray-500"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Post Button -->
                <button id="modal-post-btn" class="w-full mt-4 py-3 bg-gray-300 text-gray-500 font-bold rounded-lg cursor-not-allowed transition" disabled>
                    Đăng
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Xác nhận đăng xuất -->
    <div id="logout-modal" class="fixed inset-0 z-[9999] hidden items-center justify-center" style="background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <!-- Header -->
            <div class="p-6 text-center">
                <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                    <i data-lucide="log-out" class="w-8 h-8 text-red-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Xác nhận đăng xuất</h2>
                <p class="text-gray-600">Bạn có chắc chắn muốn đăng xuất khỏi tài khoản?</p>
            </div>
            
            <!-- Buttons -->
            <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200">
                <button id="cancel-logout" class="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition font-semibold">
                    Hủy
                </button>
                <button id="confirm-logout" class="px-6 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg transition font-semibold">
                    Đăng xuất
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 z-[10000] hidden items-center justify-center" style="background-color: rgba(0, 0, 0, 0.9);">
        <div class="relative max-w-4xl max-h-[90vh] mx-4">
            <button id="close-image-modal" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            <img id="modal-image" src="" alt="Full size image" class="max-w-full max-h-[90vh] object-contain rounded-lg">
        </div>
    </div>

    <script>
        // Kiểm tra đăng nhập ngay lập tức - không có delay
        const userInfo = localStorage.getItem('userInfo');
        
        // Nếu chưa đăng nhập, chuyển hướng ngay lập tức
        if (!userInfo) {
            window.location.replace('/login');
        } else {
            // Kiểm tra tính hợp lệ của thông tin đăng nhập
            try {
                const parsedUserInfo = JSON.parse(userInfo);
                if (!parsedUserInfo.firstName || !parsedUserInfo.loginTime) {
                    // Thông tin không hợp lệ, xóa và chuyển về login
                    localStorage.removeItem('userInfo');
                    window.location.replace('/login');
                } else {
                    // Kiểm tra thời gian đăng nhập (session timeout: 24h)
                    const loginTime = new Date(parsedUserInfo.loginTime);
                    const now = new Date();
                    const timeDiff = now - loginTime;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        // Session hết hạn
                        localStorage.removeItem('userInfo');
                        window.location.replace('/login');
                    } else {
                        // Đăng nhập hợp lệ, hiển thị trang
                        document.body.classList.add('authenticated');
                    }
                }
            } catch (error) {
                // Lỗi parse JSON, xóa và chuyển về login
                localStorage.removeItem('userInfo');
                window.location.replace('/login');
            }
        }
        
        lucide.createIcons();

        // Cấu hình API
        const API_BASE = 'http://localhost:3000/api';

        // Hàm tạo avatar từ chữ cái đầu
        function createAvatarUrl(name, size = 48) {
            const firstLetter = name.charAt(0).toUpperCase();
            const colors = ['4CAF50', 'E91E63', '3F51B5', 'FF9800', '9C27B0', 'F44336', '00BCD4', 'FFEB3B'];
            const color = colors[name.charCodeAt(0) % colors.length];
            return `https://placehold.co/${size}x${size}/${color}/FFFFFF?text=${firstLetter}`;
        }

        // Hàm format thời gian
        function formatTime(timestamp) {
            const now = new Date();
            const postTime = new Date(timestamp);
            const diff = Math.floor((now - postTime) / 1000);
            
            if (diff < 60) return 'Vừa xong';
            if (diff < 3600) return `${Math.floor(diff / 60)} phút trước`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} giờ trước`;
            return `${Math.floor(diff / 86400)} ngày trước`;
        }

        // Hàm tạo image gallery cho post
        function createImageGallery(images) {
            if (!images || images.length === 0) return '';
            
            if (images.length === 1) {
                return `<img src="${images[0].url}" alt="Post Image" class="rounded-xl w-full mb-4 cursor-pointer" onclick="openImageModal('${images[0].url}')">`;
            } else if (images.length === 2) {
                return `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        ${images.map(img => `<img src="${img.url}" alt="Post Image" class="rounded-lg w-full h-64 object-cover cursor-pointer" onclick="openImageModal('${img.url}')">`).join('')}
                    </div>
                `;
            } else if (images.length === 3) {
                return `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <img src="${images[0].url}" alt="Post Image" class="rounded-lg w-full h-80 object-cover cursor-pointer" onclick="openImageModal('${images[0].url}')">
                        <div class="grid grid-rows-2 gap-2">
                            <img src="${images[1].url}" alt="Post Image" class="rounded-lg w-full h-39 object-cover cursor-pointer" onclick="openImageModal('${images[1].url}')">
                            <img src="${images[2].url}" alt="Post Image" class="rounded-lg w-full h-39 object-cover cursor-pointer" onclick="openImageModal('${images[2].url}')">
                        </div>
                    </div>
                `;
            } else {
                // 4+ images
                return `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <img src="${images[0].url}" alt="Post Image" class="rounded-lg w-full h-80 object-cover cursor-pointer" onclick="openImageModal('${images[0].url}')">
                        <div class="grid grid-rows-2 gap-2">
                            <img src="${images[1].url}" alt="Post Image" class="rounded-lg w-full h-39 object-cover cursor-pointer" onclick="openImageModal('${images[1].url}')">
                            <div class="relative">
                                <img src="${images[2].url}" alt="Post Image" class="rounded-lg w-full h-39 object-cover cursor-pointer" onclick="showAllImages('${JSON.stringify(images).replace(/'/g, "\\'")}')">
                                ${images.length > 3 ? `<div class="absolute inset-0 bg-black bg-opacity-50 rounded-lg flex items-center justify-center cursor-pointer" onclick="showAllImages('${JSON.stringify(images).replace(/'/g, "\\'")}')">
                                    <span class="text-white text-xl font-bold">+${images.length - 3}</span>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Hàm tạo HTML cho bài viết
        function createPostHTML(post) {
            console.log('🎨 Creating HTML for post:', post);
            
            const authorName = post.author ? `${post.author.firstName} ${post.author.lastName}` : 'Unknown User';
            const authorKey = post.author ? `${post.author.firstName}_${post.author.lastName}` : 'unknown';
            
            console.log('🎨 Author info:', { authorName, authorKey, author: post.author });
            
            return `
                <div class="post-card bg-white p-5 rounded-2xl shadow-lg transition-shadow duration-300 hover:shadow-2xl" data-post-id="${post._id}">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <img src="${createAvatarUrl(authorKey)}" alt="User Avatar" class="w-12 h-12 rounded-full">
                            <div>
                                <h4 class="font-bold">${authorName}</h4>
                                <p class="text-sm text-gray-500">${formatTime(post.createdAt)}</p>
                            </div>
                        </div>
                        <div class="relative">
                            <button class="post-options-btn p-2 rounded-full hover:bg-gray-100">
                                <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                            </button>
                            <div class="post-options-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-10 origin-top-right">
                                <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="bookmark" class="w-4 h-4 mr-2"></i>Lưu bài viết</a>
                                <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="eye-off" class="w-4 h-4 mr-2"></i>Ẩn bài viết</a>
                                <a href="#" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-gray-100"><i data-lucide="flag" class="w-4 h-4 mr-2"></i>Báo cáo</a>
                            </div>
                        </div>
                    </div>
                    <p class="mb-4 text-lg">${post.content}</p>
                    ${post.images && post.images.length > 0 ? createImageGallery(post.images) : ''}
                    ${post.location ? createLocationDisplay(post.location) : ''}
                    <div class="flex justify-between items-center mt-4 text-gray-500">
                       <button class="like-button flex items-center space-x-2 hover:text-red-500 transition-transform hover:scale-110 ${post.isLikedByUser ? 'liked text-red-500' : ''}" data-tooltip="Thích">
                           <i data-lucide="heart" class="w-6 h-6"></i>
                           <span class="font-semibold">${post.likeCount || 0}</span>
                       </button>
                       <button class="comment-button flex items-center space-x-2 hover:text-blue-500 transition-transform hover:scale-110" data-tooltip="Bình luận">
                           <i data-lucide="message-circle" class="w-6 h-6"></i>
                           <span class="font-semibold">${post.commentCount || 0}</span>
                       </button>
                       <button class="share-button flex items-center space-x-2 hover:text-green-500 transition-transform hover:scale-110" data-tooltip="Chia sẻ">
                           <i data-lucide="share-2" class="w-6 h-6"></i>
                           <span class="share-count">${post.shareCount || 0}</span>
                       </button>
                    </div>
                </div>
            `;
        }

        // Hàm load bài viết từ API
        async function loadPosts() {
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                console.log('LoadPosts: Token check:', token ? 'exists' : 'missing');
                
                if (!token) {
                    console.log('LoadPosts: No token found, redirecting to login');
                    // Thêm delay để tránh conflict
                    setTimeout(() => {
                        if (!window.location.pathname.includes('login')) {
                            window.location.href = '/login';
                        }
                    }, 100);
                    return;
                }

                console.log('LoadPosts: Fetching posts...');
                const response = await fetch('/api/posts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('LoadPosts: API response status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('LoadPosts: Token expired, clearing and redirecting');
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('token');
                        localStorage.removeItem('userInfo');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 100);
                        return;
                    }
                    throw new Error(`Failed to fetch posts: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('LoadPosts: Raw API response:', data);
                console.log('LoadPosts: Response structure:', {
                    success: data.success,
                    posts: data.posts,
                    postsLength: data.posts?.length || 0,
                    postsType: typeof data.posts
                });
                
                // Handle both response formats
                let posts;
                if (data.success && data.posts) {
                    posts = data.posts;
                } else if (Array.isArray(data)) {
                    posts = data;
                } else {
                    posts = [];
                }
                
                console.log('LoadPosts: Final posts array:', posts, 'Length:', posts.length);
                
                const postsFeed = document.getElementById('posts-feed');
                const emptyPosts = document.getElementById('empty-posts');
                
                if (posts.length === 0) {
                    emptyPosts.style.display = 'block';
                    postsFeed.innerHTML = '';
                } else {
                    emptyPosts.style.display = 'none';
                    postsFeed.innerHTML = posts.map(post => createPostHTML(post)).join('');
                    
                    // Tái tạo icons sau khi thêm HTML mới
                    lucide.createIcons();
                    
                    // Gắn lại tooltips
                    attachTooltips();
                }
            } catch (error) {
                console.error('LoadPosts: Error loading posts:', error);
                
                // Chỉ clear và redirect nếu là lỗi authentication
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    console.log('LoadPosts: Authentication error, clearing storage and redirecting');
                    localStorage.removeItem('token');
                    localStorage.removeItem('userInfo');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 100);
                } else {
                    // Lỗi khác, hiển thị thông báo mà không redirect
                    console.log('LoadPosts: Network or other error, showing message');
                    const postsFeed = document.getElementById('posts-feed');
                    if (postsFeed) {
                        postsFeed.innerHTML = '<div class="text-center text-red-500 p-4">Không thể tải bài viết. Vui lòng thử lại sau.</div>';
                    }
                }
            }
        }

        // Hàm tạo location display cho post
        function createLocationDisplay(location) {
            if (!location) return '';
            
            return `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg border">
                    <div class="flex items-center text-sm text-gray-600">
                        <i data-lucide="map-pin" class="w-4 h-4 text-red-500 mr-2"></i>
                        <span class="font-medium">${location.name || location.address || 'Vị trí'}</span>
                    </div>
                    ${location.address && location.address !== location.name ? `
                        <div class="text-xs text-gray-500 ml-6 mt-1">${location.address}</div>
                    ` : ''}
                </div>
            `;
        }

        // Functions xử lý image modal
        function openImageModal(imageUrl) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            modalImage.src = imageUrl;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        function showAllImages(imagesJson) {
            // For now, just show the first image. Could be extended to show gallery
            try {
                const images = JSON.parse(imagesJson);
                if (images && images.length > 0) {
                    openImageModal(images[0].url);
                }
            } catch (e) {
                console.error('Error parsing images:', e);
            }
        }

        // Hàm tạo bài viết mới
        async function createPost(content, images = [], location = null) {
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return false;
                }

                // Sử dụng FormData để gửi cả text, files và location
                const formData = new FormData();
                formData.append('content', content);
                formData.append('privacy', 'public');
                
                // Thêm location data nếu có
                if (location) {
                    formData.append('location', JSON.stringify(location));
                }
                
                // Thêm các file ảnh vào FormData
                images.forEach((file, index) => {
                    formData.append('images', file);
                });

                console.log('Creating post with', images.length, 'images and location:', location);

                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                        // Không set Content-Type khi dùng FormData, browser sẽ tự set
                    },
                    body: formData
                });
                
                if (response.ok) {
                    // Reload bài viết sau khi tạo
                    await loadPosts();
                    return true;
                } else {
                    const error = await response.json();
                    alert('Lỗi khi tạo bài viết: ' + (error.error || 'Unknown error'));
                    return false;
                }
            } catch (error) {
                console.error('Lỗi khi tạo bài viết:', error);
                alert('Lỗi khi tạo bài viết');
                return false;
            }
        }

        // Hàm like/unlike bài viết
        async function toggleLike(postId) {
            console.log('🔥 toggleLike called with postId:', postId);
            
            // Tìm button và update UI ngay lập tức (optimistic update)
            const postCard = document.querySelector(`[data-post-id="${postId}"]`);
            const likeButton = postCard.querySelector('.like-button');
            const likeCount = likeButton.querySelector('span');
            
            // Prevent double-clicking
            if (likeButton.disabled) {
                console.log('⚠️ Like button disabled, preventing double-click');
                return;
            }
            likeButton.disabled = true;
            
            // Kiểm tra trạng thái hiện tại
            const currentlyLiked = likeButton.classList.contains('liked');
            const currentCount = parseInt(likeCount.textContent) || 0;
            
            console.log('🔍 Current state - Liked:', currentlyLiked, 'Count:', currentCount);
            
            // Update UI ngay lập tức (optimistic)
            if (currentlyLiked) {
                // Currently liked, so unlike
                likeButton.classList.remove('liked');
                likeButton.classList.remove('text-red-500');
                likeButton.style.color = '#6b7280';
                const newCount = Math.max(0, currentCount - 1);
                likeCount.textContent = newCount;
                console.log('🤍 Optimistic unlike - count changed from', currentCount, 'to', newCount);
            } else {
                // Currently not liked, so like
                likeButton.classList.add('liked');
                likeButton.classList.add('text-red-500');
                likeButton.style.color = '#ef4444';
                const newCount = currentCount + 1;
                likeCount.textContent = newCount;
                console.log('❤️ Optimistic like - count changed from', currentCount, 'to', newCount);
            }
            
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                console.log('🔑 Token for like:', token ? 'exists' : 'missing');
                
                const response = await fetch(`${API_BASE}/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('👍 Like response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('👍 Like result:', result);
                    
                    if (result.success) {
                        // Server confirmed success, sync the UI
                        const serverCount = result.likeCount;
                        const currentUICount = parseInt(likeCount.textContent) || 0;
                        
                        console.log('🔄 Server response - Liked:', result.liked, 'Count:', serverCount);
                        console.log('🖥️ UI state before sync - Count:', currentUICount);
                        
                        // Only update if server count differs from UI
                        if (serverCount !== currentUICount) {
                            likeCount.textContent = serverCount;
                            console.log('📊 Count synced from', currentUICount, 'to', serverCount);
                        } else {
                            console.log('✅ Count already matches server:', serverCount);
                        }
                        
                        // Ensure UI state matches server response
                        if (result.liked && !likeButton.classList.contains('liked')) {
                            likeButton.classList.add('liked');
                            likeButton.classList.add('text-red-500');
                            likeButton.style.color = '#ef4444';
                            console.log('🔴 Fixed UI state to liked');
                        } else if (!result.liked && likeButton.classList.contains('liked')) {
                            likeButton.classList.remove('liked');
                            likeButton.classList.remove('text-red-500');
                            likeButton.style.color = '#6b7280';
                            console.log('⚪ Fixed UI state to unliked');
                        } else {
                            console.log('✅ UI state already matches server');
                        }
                    }
                } else {
                    console.warn('⚠️ Like request failed, keeping optimistic update');
                    // Keep the optimistic update since we can't confirm from server
                }
            } catch (error) {
                console.error('💥 Like error:', error);
                console.warn('⚠️ Network error, keeping optimistic update');
                // Keep the optimistic update - better UX than reverting
            } finally {
                // Always re-enable the button
                likeButton.disabled = false;
            }
        }

        // Hàm toggle hiển thị comments
        async function toggleComments(postId) {
            try {
                const postCard = document.querySelector(`[data-post-id="${postId}"]`);
                let commentsSection = postCard.querySelector('.comments-section');
                
                if (commentsSection) {
                    // Nếu đã hiển thị thì ẩn đi
                    commentsSection.remove();
                    return;
                }
                
                // Tạo comment section
                const response = await fetch(`${API_BASE}/posts/${postId}/comments`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('accessToken') || localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        commentsSection = document.createElement('div');
                        commentsSection.className = 'comments-section mt-4 border-t pt-4';
                        
                        // Comment input
                        commentsSection.innerHTML = `
                            <div class="flex items-center space-x-2 mb-4">
                                <input type="text" placeholder="Viết bình luận..." 
                                       class="comment-input flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button class="submit-comment bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    Gửi
                                </button>
                            </div>
                            <div class="comments-list space-y-2">
                                ${result.comments.map(comment => `
                                    <div class="flex items-start space-x-2 p-2 bg-gray-50 rounded">
                                        <div class="font-semibold text-sm">${comment.user?.firstName || 'User'}:</div>
                                        <div class="text-sm">${comment.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                        postCard.appendChild(commentsSection);
                        
                        // Add event listener for submit comment
                        const submitBtn = commentsSection.querySelector('.submit-comment');
                        const commentInput = commentsSection.querySelector('.comment-input');
                        
                        submitBtn.addEventListener('click', () => submitComment(postId, commentInput));
                        commentInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                submitComment(postId, commentInput);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Lỗi khi load comments:', error);
            }
        }

        // Hàm gửi comment
        async function submitComment(postId, inputElement) {
            const content = inputElement.value.trim();
            if (!content) return;
            
            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/comment`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('accessToken') || localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Clear input
                        inputElement.value = '';
                        
                        // Add new comment to list
                        const postCard = document.querySelector(`[data-post-id="${postId}"]`);
                        const commentsList = postCard.querySelector('.comments-list');
                        const newCommentDiv = document.createElement('div');
                        newCommentDiv.className = 'flex items-start space-x-2 p-2 bg-gray-50 rounded';
                        newCommentDiv.innerHTML = `
                            <div class="font-semibold text-sm">${result.comment.user?.firstName || 'You'}:</div>
                            <div class="text-sm">${result.comment.content}</div>
                        `;
                        commentsList.appendChild(newCommentDiv);
                        
                        // Update comment count in button
                        const commentButton = postCard.querySelector('.comment-button span');
                        commentButton.textContent = result.commentCount;
                    }
                }
            } catch (error) {
                console.error('Lỗi khi gửi comment:', error);
            }
        }

        // Hàm share bài viết
        async function sharePost(postId) {
            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/share`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('accessToken') || localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Cập nhật số share
                        const postCard = document.querySelector(`[data-post-id="${postId}"]`);
                        const shareCount = postCard.querySelector('.share-count');
                        shareCount.textContent = result.shareCount;
                        
                        // Hiển thị thông báo
                        showNotification('Đã chia sẻ bài viết!', 'success');
                    }
                }
            } catch (error) {
                console.error('Lỗi khi share bài viết:', error);
            }
        }

        // Hàm hiển thị notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        window.onload = function() {
            console.log('Index page: Page loaded, checking authentication...');
            
            // Check authentication trước
            const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            
            console.log('Index page: Token exists:', !!token);
            console.log('Index page: UserInfo exists:', !!userInfo);
            
            if (!token || !userInfo) {
                console.log('Index page: Missing authentication, redirecting to login...');
                // Chỉ redirect nếu không phải đang ở trang login
                if (!window.location.pathname.includes('login')) {
                    // Delay nhỏ để tránh conflict với login page
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 100);
                }
                return;
            }
            
            console.log('Index page: Authentication found, initializing page...');
            
            const postsFeed = document.getElementById('posts-feed');
            const createPostModal = document.getElementById('create-post-modal');
            const postPlaceholder = document.getElementById('post-placeholder');
            const closeModal = document.getElementById('close-modal');
            const modalPostContent = document.getElementById('modal-post-content');
            const modalPostBtn = document.getElementById('modal-post-btn');
            
            // Elements cho image upload
            const toggleImageUpload = document.getElementById('toggle-image-upload');
            const imageUploadSection = document.getElementById('image-upload-section');
            const dropZone = document.getElementById('drop-zone');
            const selectImageBtn = document.getElementById('select-image-btn');
            const imageInput = document.getElementById('image-input');
            const imagePreview = document.getElementById('image-preview');
            
            // Elements cho location
            const toggleLocation = document.getElementById('toggle-location');
            const locationSection = document.getElementById('location-section');
            const locationSearch = document.getElementById('location-search');
            const getCurrentLocationBtn = document.getElementById('get-current-location');
            const locationResults = document.getElementById('location-results');
            const selectedLocation = document.getElementById('selected-location');
            const selectedLocationText = document.getElementById('selected-location-text');
            const removeLocationBtn = document.getElementById('remove-location');
            
            // Array để lưu các file ảnh đã chọn
            let selectedImages = [];
            
            // Object để lưu vị trí đã chọn
            let selectedLocationData = null;
            
            // Functions xử lý image upload
            function showImageUploadSection() {
                imageUploadSection.classList.remove('hidden');
                toggleImageUpload.classList.add('bg-green-100');
            }
            
            function hideImageUploadSection() {
                imageUploadSection.classList.add('hidden');
                toggleImageUpload.classList.remove('bg-green-100');
            }
            
            function addImageToPreview(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-preview-item';
                    imageItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-image" data-index="${selectedImages.length - 1}">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    `;
                    imagePreview.appendChild(imageItem);
                    imagePreview.classList.remove('hidden');
                    
                    // Khởi tạo lại lucide icons
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            }
            
            function removeImageFromPreview(index) {
                selectedImages.splice(index, 1);
                renderImagePreviews();
            }
            
            function renderImagePreviews() {
                imagePreview.innerHTML = '';
                selectedImages.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-preview-item';
                        imageItem.innerHTML = `
                            <img src="${e.target.result}" alt="Preview">
                            <button class="remove-image" onclick="removeImageFromPreview(${index})">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        `;
                        imagePreview.appendChild(imageItem);
                        lucide.createIcons();
                    };
                    reader.readAsDataURL(file);
                });
                
                if (selectedImages.length === 0) {
                    imagePreview.classList.add('hidden');
                } else {
                    imagePreview.classList.remove('hidden');
                }
                
                // Update post button state
                updatePostButtonState();
            }
            
            // Location Functions
            function showLocationSection() {
                locationSection.classList.remove('hidden');
                toggleLocation.classList.add('bg-red-100');
            }
            
            function hideLocationSection() {
                locationSection.classList.add('hidden');
                toggleLocation.classList.remove('bg-red-100');
            }
            
            function searchLocation(query) {
                if (!query || query.length < 3) {
                    locationResults.classList.add('hidden');
                    return;
                }
                
                // Call backend API to search locations using Google Places API
                fetch(`/api/location/search?q=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('accessToken') || localStorage.getItem('token')}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.locations) {
                        displayLocationResults(data.locations);
                    } else {
                        console.error('Location search failed:', data.error);
                        locationResults.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('Location search error:', error);
                    locationResults.classList.add('hidden');
                });
            }
            
            function displayLocationResults(locations) {
                locationResults.innerHTML = '';
                
                locations.forEach(location => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'location-result-item';
                    resultItem.innerHTML = `
                        <div class="flex items-center">
                            <i data-lucide="map-pin" class="w-4 h-4 text-red-500 mr-3"></i>
                            <div>
                                <div class="font-medium text-gray-800">${location.name}</div>
                                <div class="text-sm text-gray-500">${location.address}</div>
                            </div>
                        </div>
                    `;
                    
                    resultItem.addEventListener('click', () => {
                        selectLocation(location);
                    });
                    
                    locationResults.appendChild(resultItem);
                });
                
                locationResults.classList.remove('hidden');
                lucide.createIcons();
            }
            
            function selectLocation(locationData) {
                selectedLocationData = locationData;
                selectedLocationText.textContent = locationData.name;
                selectedLocation.classList.remove('hidden');
                locationResults.classList.add('hidden');
                locationSearch.value = '';
                
                // Update post button state
                updatePostButtonState();
            }
            
            function removeLocation() {
                selectedLocationData = null;
                selectedLocation.classList.add('hidden');
                updatePostButtonState();
            }
            
            function getCurrentLocation() {
                if (!navigator.geolocation) {
                    alert('Trình duyệt không hỗ trợ định vị!');
                    return;
                }
                
                getCurrentLocationBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i>';
                
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        try {
                            // Call backend API for reverse geocoding
                            const response = await fetch('/api/location/reverse', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('accessToken') || localStorage.getItem('token')}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ lat, lng })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success && data.location) {
                                selectLocation(data.location);
                            } else {
                                // Fallback to coordinates if reverse geocoding fails
                                const fallbackLocation = {
                                    name: 'Vị trí hiện tại',
                                    address: `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                                    lat: lat,
                                    lng: lng
                                };
                                selectLocation(fallbackLocation);
                            }
                        } catch (error) {
                            console.error('Reverse geocoding error:', error);
                            // Fallback to coordinates
                            const fallbackLocation = {
                                name: 'Vị trí hiện tại',
                                address: `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                                lat: lat,
                                lng: lng
                            };
                            selectLocation(fallbackLocation);
                        }
                        
                        getCurrentLocationBtn.innerHTML = '<i data-lucide="navigation" class="w-5 h-5"></i>';
                        lucide.createIcons();
                    },
                    (error) => {
                        alert('Không thể lấy vị trí hiện tại!');
                        getCurrentLocationBtn.innerHTML = '<i data-lucide="navigation" class="w-5 h-5"></i>';
                        lucide.createIcons();
                    }
                );
            }
            
            function validateImageFile(file) {
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('Chỉ chấp nhận file ảnh!');
                    return false;
                }
                
                // Check file size (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Kích thước ảnh không được vượt quá 10MB!');
                    return false;
                }
                
                return true;
            }
            
            function updatePostButtonState() {
                const hasContent = modalPostContent.value.trim();
                const hasImages = selectedImages.length > 0;
                const hasLocation = selectedLocationData !== null;
                
                if (hasContent || hasImages || hasLocation) {
                    modalPostBtn.disabled = false;
                    modalPostBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    modalPostBtn.classList.add('bg-black', 'text-white', 'hover:bg-gray-800');
                } else {
                    modalPostBtn.disabled = true;
                    modalPostBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    modalPostBtn.classList.remove('bg-black', 'text-white', 'hover:bg-gray-800');
                }
            }
            
            // Elements cho logout modal
            const logoutBtn = document.getElementById('logout-btn');
            const logoutModal = document.getElementById('logout-modal');
            const cancelLogout = document.getElementById('cancel-logout');
            const confirmLogout = document.getElementById('confirm-logout');
            
            // Test token và load posts
            console.log('Index page: Testing token and loading posts...');
            loadPosts();
            
            // Image Upload Event Listeners
            
            // Toggle image upload section
            toggleImageUpload.addEventListener('click', function() {
                if (imageUploadSection.classList.contains('hidden')) {
                    showImageUploadSection();
                } else {
                    hideImageUploadSection();
                }
            });
            
            // Select image button
            selectImageBtn.addEventListener('click', function() {
                imageInput.click();
            });
            
            // File input change
            imageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (validateImageFile(file)) {
                        selectedImages.push(file);
                    }
                });
                renderImagePreviews();
                e.target.value = ''; // Reset input
            });
            
            // Drag & Drop Events
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                files.forEach(file => {
                    if (validateImageFile(file)) {
                        selectedImages.push(file);
                    }
                });
                renderImagePreviews();
            });
            
            // Make removeImageFromPreview global
            window.removeImageFromPreview = removeImageFromPreview;
            
            // Location Event Listeners
            
            // Toggle location section
            toggleLocation.addEventListener('click', function() {
                if (locationSection.classList.contains('hidden')) {
                    showLocationSection();
                } else {
                    hideLocationSection();
                }
            });
            
            // Location search
            let searchTimeout;
            locationSearch.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 3) {
                    locationResults.classList.add('hidden');
                    return;
                }
                
                // Debounce search
                searchTimeout = setTimeout(() => {
                    searchLocation(query);
                }, 300);
            });
            
            // Get current location
            getCurrentLocationBtn.addEventListener('click', getCurrentLocation);
            
            // Remove selected location
            removeLocationBtn.addEventListener('click', removeLocation);
            
            // Hide location results when clicking outside
            document.addEventListener('click', function(e) {
                if (!locationSection.contains(e.target)) {
                    locationResults.classList.add('hidden');
                }
            });
            
            // Image Modal Event Listeners
            const imageModal = document.getElementById('image-modal');
            const closeImageModalBtn = document.getElementById('close-image-modal');
            
            closeImageModalBtn.addEventListener('click', closeImageModal);
            
            // Close modal when clicking outside the image
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    closeImageModal();
                }
            });
            
            // Make image functions global
            window.openImageModal = openImageModal;
            window.showAllImages = showAllImages;
            
            // Xử lý chức năng đăng xuất
            logoutBtn.addEventListener('click', function() {
                logoutModal.classList.remove('hidden');
                logoutModal.classList.add('flex');
            });
            
            // Hủy đăng xuất
            cancelLogout.addEventListener('click', function() {
                logoutModal.classList.add('hidden');
                logoutModal.classList.remove('flex');
            });
            
            // Xác nhận đăng xuất
            confirmLogout.addEventListener('click', function() {
                // Xóa tất cả thông tin người dùng khỏi localStorage
                localStorage.removeItem('userInfo');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('token');
                
                // Hiển thị thông báo đăng xuất thành công
                alert('Đăng xuất thành công!');
                
                // Chuyển hướng về trang đăng nhập hoặc reload trang
                // Ở đây có thể chuyển hướng đến trang login nếu có
                window.location.href = '/login';  // hoặc window.location.reload();
            });
            
            // Đóng logout modal khi click ra ngoài
            logoutModal.addEventListener('click', function(e) {
                if (e.target === logoutModal) {
                    cancelLogout.click();
                }
            });
            
            // Mở modal khi nhấn vào "Bạn đang nghĩ gì"
            postPlaceholder.addEventListener('click', function() {
                createPostModal.classList.remove('hidden');
                createPostModal.classList.add('flex');
                modalPostContent.focus();
            });
            
            // Đóng modal khi nhấn nút X
            closeModal.addEventListener('click', function() {
                createPostModal.classList.add('hidden');
                createPostModal.classList.remove('flex');
                modalPostContent.value = '';
                
                // Reset image upload
                selectedImages = [];
                hideImageUploadSection();
                renderImagePreviews();
                
                // Reset location
                selectedLocationData = null;
                hideLocationSection();
                selectedLocation.classList.add('hidden');
                locationResults.classList.add('hidden');
                locationSearch.value = '';
                
                modalPostBtn.disabled = true;
                modalPostBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                modalPostBtn.classList.remove('bg-black', 'text-white', 'hover:bg-gray-800');
            });
            
            // Đóng modal khi nhấn ra ngoài
            createPostModal.addEventListener('click', function(e) {
                if (e.target === createPostModal) {
                    closeModal.click();
                }
            });
            
            // Kích hoạt nút Đăng khi có nội dung hoặc ảnh
            modalPostContent.addEventListener('input', function() {
                updatePostButtonState();
            });
            
            // Xử lý khi nhấn nút Đăng
            modalPostBtn.addEventListener('click', async function() {
                const content = modalPostContent.value.trim();
                if (content || selectedImages.length > 0 || selectedLocationData) {
                    const success = await createPost(content, selectedImages, selectedLocationData);
                    if (success) {
                        closeModal.click();
                    }
                }
            });
            
            // Logic mở/đóng menu tùy chọn
            document.body.addEventListener('click', function(e) {
                const isOptionsBtn = e.target.closest('.post-options-btn');
                
                // Đóng tất cả các menu khác
                document.querySelectorAll('.post-options-menu').forEach(menu => {
                    if (!isOptionsBtn || !menu.previousElementSibling.isEqualNode(isOptionsBtn)) {
                        menu.classList.add('hidden');
                        menu.classList.remove('opacity-100', 'scale-100');
                        menu.classList.add('opacity-0', 'scale-95');
                    }
                });

                if (isOptionsBtn) {
                    const menu = isOptionsBtn.nextElementSibling;
                    const isHidden = menu.classList.toggle('hidden');
                    if (!isHidden) {
                         // Dùng setTimeout để trình duyệt kịp render trước khi transition
                        setTimeout(() => {
                            menu.classList.remove('opacity-0', 'scale-95');
                            menu.classList.add('opacity-100', 'scale-100');
                        }, 10);
                    }
                }
            });

            // Logic cho các hành động trong menu (like, delete, etc.)
            postsFeed.addEventListener('click', async function(e) {
                console.log('🖱️ Click detected on:', e.target);
                
                const likeButton = e.target.closest('.like-button');
                if (likeButton) {
                    console.log('💖 Like button clicked!');
                    const postCard = likeButton.closest('.post-card');
                    const postId = postCard.dataset.postId;
                    console.log('📝 Post ID:', postId);
                    await toggleLike(postId);
                }

                const commentButton = e.target.closest('.comment-button');
                if (commentButton) {
                    console.log('💬 Comment button clicked!');
                    const postCard = commentButton.closest('.post-card');
                    const postId = postCard.dataset.postId;
                    await toggleComments(postId);
                }

                const shareButton = e.target.closest('.share-button');
                if (shareButton) {
                    console.log('📤 Share button clicked!');
                    const postCard = shareButton.closest('.post-card');
                    const postId = postCard.dataset.postId;
                    await sharePost(postId);
                }

                const deleteButton = e.target.closest('.delete-post-btn');
                if (deleteButton) {
                    const postCard = deleteButton.closest('.post-card');
                    if (postCard) {
                        postCard.style.transition = 'opacity 0.5s ease';
                        postCard.style.opacity = '0';
                        setTimeout(() => postCard.remove(), 500);
                    }
                }
            });
            
            // Tooltip System - JavaScript Dynamic Tooltips
            function createTooltip() {
                const tooltip = document.createElement('div');
                tooltip.id = 'dynamic-tooltip';
                tooltip.style.cssText = `
                    position: absolute;
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    font-weight: 500;
                    white-space: nowrap;
                    z-index: 10000;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.2s ease;
                    transform: translateY(-5px);
                `;
                document.body.appendChild(tooltip);
                return tooltip;
            }
            
            function showTooltip(element, text) {
                let tooltip = document.getElementById('dynamic-tooltip');
                if (!tooltip) {
                    tooltip = createTooltip();
                }
                
                const rect = element.getBoundingClientRect();
                tooltip.textContent = text;
                tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 10 + window.scrollY) + 'px';
                tooltip.style.opacity = '1';
            }
            
            function hideTooltip() {
                const tooltip = document.getElementById('dynamic-tooltip');
                if (tooltip) {
                    tooltip.style.opacity = '0';
                }
            }
            
            // Gắn tooltip cho các button
            window.attachTooltips = function() {
                document.querySelectorAll('[data-tooltip]').forEach(element => {
                    element.addEventListener('mouseenter', function() {
                        showTooltip(this, this.getAttribute('data-tooltip'));
                    });
                    
                    element.addEventListener('mouseleave', function() {
                        hideTooltip();
                    });
                });
            }
            
            // Khởi tạo tooltips khi DOM đã sẵn sàng
            attachTooltips();

            // Cập nhật thông tin người dùng từ localStorage và server
            const updateUserInfo = async () => {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                if (userInfo.firstName) {
                    // Chỉ sử dụng firstName (tên)
                    const firstName = userInfo.firstName;
                    
                    // Cập nhật tên người dùng trong sidebar với chào mừng (xuống dòng)
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.innerHTML = `Chào mừng<br>${firstName}`;
                    }

                    // Cập nhật placeholder trong post
                    const postPlaceholder = document.getElementById('post-placeholder');
                    if (postPlaceholder) {
                        postPlaceholder.textContent = `Bạn đang nghĩ gì, ${firstName}?`;
                    }
                    
                    // Cập nhật thông tin trong modal
                    const modalUserName = document.getElementById('modal-user-name');
                    if (modalUserName) {
                        modalUserName.textContent = firstName;
                    }

                    // Load avatar từ server
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        if (token) {
                            const response = await fetch('/api/user-profile', {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (response.ok) {
                                const profile = await response.json();
                                
                                // Cập nhật avatar nếu có từ server
                                const userAvatar = document.getElementById('user-avatar');
                                const postUserAvatar = document.getElementById('post-user-avatar');
                                const modalUserAvatar = document.getElementById('modal-user-avatar');
                                
                                if (profile.avatar) {
                                    // Sử dụng avatar từ server
                                    if (userAvatar) userAvatar.src = profile.avatar;
                                    if (postUserAvatar) postUserAvatar.src = profile.avatar;
                                    if (modalUserAvatar) modalUserAvatar.src = profile.avatar;
                                } else {
                                    // Fallback về avatar mặc định
                                    const firstLetter = firstName.charAt(0).toUpperCase();
                                    if (userAvatar) {
                                        userAvatar.src = `https://placehold.co/56x56/000000/FFFFFF?text=${firstLetter}`;
                                    }
                                    if (postUserAvatar) {
                                        postUserAvatar.src = `https://placehold.co/48x48/000000/FFFFFF?text=${firstLetter}`;
                                    }
                                    if (modalUserAvatar) {
                                        modalUserAvatar.src = `https://placehold.co/48x48/000000/FFFFFF?text=${firstLetter}`;
                                    }
                                }
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load profile:', error);
                    }
                    
                    // Fallback nếu không load được từ server
                    const firstLetter = firstName.charAt(0).toUpperCase();
                    const userAvatar = document.getElementById('user-avatar');
                    const postUserAvatar = document.getElementById('post-user-avatar');
                    const modalUserAvatar = document.getElementById('modal-user-avatar');
                    
                    if (userAvatar) {
                        userAvatar.src = `https://placehold.co/56x56/000000/FFFFFF?text=${firstLetter}`;
                    }
                    if (postUserAvatar) {
                        postUserAvatar.src = `https://placehold.co/48x48/000000/FFFFFF?text=${firstLetter}`;
                    }
                    if (modalUserAvatar) {
                        modalUserAvatar.src = `https://placehold.co/48x48/000000/FFFFFF?text=${firstLetter}`;
                    }
                }
            };

            // Header search functionality
            const initializeHeaderSearch = () => {
                const searchInput = document.getElementById('header-search');
                const searchDropdown = document.getElementById('search-dropdown');
                const searchResults = document.getElementById('search-results');
                let searchTimeout;

                if (!searchInput) return;

                // Handle search input
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    clearTimeout(searchTimeout);
                    
                    if (query.length < 2) {
                        searchDropdown.classList.add('hidden');
                        return;
                    }

                    // Debounce search
                    searchTimeout = setTimeout(() => {
                        performSearch(query);
                    }, 300);
                });

                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#header-search') && !e.target.closest('#search-dropdown')) {
                        searchDropdown.classList.add('hidden');
                    }
                });

                // Perform search API call
                async function performSearch(query) {
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        
                        searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">Đang tìm kiếm...</div>';
                        searchDropdown.classList.remove('hidden');

                        const response = await fetch(`/api/friends/search?q=${encodeURIComponent(query)}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Search failed');
                        }

                        const data = await response.json();
                        displaySearchResults(data.users || []);

                    } catch (error) {
                        console.error('Search error:', error);
                        searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Lỗi tìm kiếm</div>';
                    }
                }

                // Display search results
                function displaySearchResults(users) {
                    console.log('displaySearchResults called with users:', users);
                    if (users.length === 0) {
                        searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">Không tìm thấy kết quả</div>';
                        return;
                    }

                    const resultsHTML = users.map(user => {
                        console.log('🧑 Processing user:', {
                            id: user.id,
                            _id: user._id,
                            firstName: user.firstName,
                            lastName: user.lastName,
                            email: user.email
                        });
                        
                        const userId = user.id || user._id;
                        console.log('📋 Using userId:', userId);
                        
                        let actionButton = '';
                        
                        switch (user.friendshipStatus) {
                            case 'accepted':
                                actionButton = '<span class="text-green-600 text-sm font-medium">Đã là bạn</span>';
                                break;
                            case 'pending':
                                if (user.friendshipPerspective === 'sent') {
                                    actionButton = '<span class="text-gray-500 text-sm">Đã gửi lời mời</span>';
                                } else {
                                    actionButton = `<button class="text-blue-500 hover:text-blue-700 text-sm font-medium" onclick="event.stopPropagation(); acceptFromHeader('${user.friendshipId}')">Chấp nhận</button>`;
                                }
                                break;
                            default:
                                actionButton = '';
                        }

                        return `
                            <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition user-profile-link" data-user-id="${userId}">
                                <img src="${user.avatar || user.profile?.avatar || 'https://placehold.co/40x40/000000/FFFFFF?text=' + (user.firstName?.charAt(0) || user.email?.charAt(0) || 'U')}" 
                                     alt="${user.firstName || user.username}" 
                                     class="w-10 h-10 rounded-full mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-sm">${user.name || (user.firstName + ' ' + user.lastName).trim() || user.email}</div>
                                    <div class="text-gray-500 text-xs">${user.email}</div>
                                </div>
                                ${actionButton}
                            </div>
                        `;
                    }).join('');

                    searchResults.innerHTML = resultsHTML;
                    
                    // Add click event listeners to profile links
                    const profileLinks = searchResults.querySelectorAll('.user-profile-link');
                    profileLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const userId = link.getAttribute('data-user-id');
                            console.log('Profile link clicked, userId:', userId);
                            viewUserProfile(userId);
                        });
                    });
                }

                // View user profile function
                function viewUserProfile(userId) {
                    console.log('🔍 viewUserProfile called with userId:', userId);
                    console.log('🔍 userId type:', typeof userId);
                    console.log('🔍 userId value:', JSON.stringify(userId));
                    
                    if (!userId || userId === 'undefined' || userId === 'null') {
                        console.error('❌ Invalid userId provided:', userId);
                        return;
                    }
                    
                    searchDropdown.classList.add('hidden');
                    searchInput.value = '';
                    
                    // Redirect to profile page with user ID
                    const profileUrl = `/profile?user=${encodeURIComponent(userId)}`;
                    console.log('🚀 Redirecting to:', profileUrl);
                    window.location.href = profileUrl;
                }

                // Send friend request from header search
                window.sendFriendRequestFromHeader = async (userId) => {
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        
                        const response = await fetch('/api/friends/request', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ recipientId: userId })
                        });

                        if (response.ok) {
                            // Update UI - change button to "Đã gửi"
                            event.target.textContent = 'Đã gửi';
                            event.target.disabled = true;
                            event.target.classList.remove('text-blue-500', 'hover:text-blue-700');
                            event.target.classList.add('text-gray-500');
                            
                            // Show success message
                            showNotification('Đã gửi lời mời kết bạn!', 'success');
                        } else {
                            throw new Error('Failed to send friend request');
                        }
                    } catch (error) {
                        console.error('Error sending friend request:', error);
                        showNotification('Lỗi khi gửi lời mời kết bạn', 'error');
                    }
                };

                // Accept friend request from header search
                window.acceptFromHeader = async (friendshipId) => {
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        
                        const response = await fetch(`/api/friends/accept/${friendshipId}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            // Show success message
                            showNotification('Đã chấp nhận lời mời kết bạn!', 'success');
                            
                            // Update UI
                            event.target.textContent = 'Đã là bạn';
                            event.target.disabled = true;
                            event.target.classList.remove('text-blue-500', 'hover:text-blue-700');
                            event.target.classList.add('text-green-600');
                        } else {
                            throw new Error('Failed to accept friend request');
                        }
                    } catch (error) {
                        console.error('Error accepting friend request:', error);
                        showNotification('Lỗi khi chấp nhận lời mời kết bạn', 'error');
                    }
                };

                // Send friend request
                window.sendFriendRequest = async (userId) => {
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        
                        const response = await fetch('/api/friends/request', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ recipientId: userId })
                        });

                        if (response.ok) {
                            // Update UI - change button to "Đã gửi"
                            event.target.textContent = 'Đã gửi';
                            event.target.disabled = true;
                            event.target.classList.remove('text-blue-500', 'hover:text-blue-700');
                            event.target.classList.add('text-gray-500');
                            
                            // Show success message
                            showNotification('Đã gửi lời mời kết bạn!', 'success');
                        } else {
                            throw new Error('Failed to send friend request');
                        }
                    } catch (error) {
                        console.error('Error sending friend request:', error);
                        showNotification('Lỗi khi gửi lời mời kết bạn', 'error');
                    }
                };

                // Show notification
                function showNotification(message, type = 'info') {
                    // Tạo notification element
                    const notification = document.createElement('div');
                    notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
                        type === 'success' ? 'bg-green-500 text-white' : 
                        type === 'error' ? 'bg-red-500 text-white' : 
                        'bg-blue-500 text-white'
                    }`;
                    notification.textContent = message;
                    
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full');
                    }, 100);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 300);
                    }, 3000);
                }
            };

            // Gọi hàm cập nhật thông tin người dùng khi trang load
            updateUserInfo();
            initializeHeaderSearch();
            loadNotificationCount();
            loadFriendSuggestions();
            loadTrendingTopics();

            // Reload data periodically
            setInterval(loadNotificationCount, 30000); // 30 seconds
            setInterval(loadFriendSuggestions, 60000); // 1 minute
            setInterval(loadTrendingTopics, 120000); // 2 minutes
        };

        // Load notification count
        async function loadNotificationCount() {
            try {
                const response = await fetch('/api/notifications/unread-count', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('notification-badge');
                    const count = data.count || 0;
                    
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count.toString();
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading notification count:', error);
            }
        }

        // Load friend suggestions
        async function loadFriendSuggestions() {
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                const response = await fetch('/api/friends/suggestions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const suggestionsContainer = document.getElementById('friend-suggestions');
                    
                    if (data.success && data.suggestions && data.suggestions.length > 0) {
                        const suggestionsHTML = data.suggestions.slice(0, 5).map(user => {
                            const userName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                            const avatarUrl = user.avatar || createAvatarUrl(userName);
                            const mutualFriends = user.mutualFriendsCount || 0;
                            
                            return `
                                <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition">
                                    <div class="flex items-center space-x-3 flex-1 cursor-pointer" onclick="viewUserProfile('${user._id || user.id}')">
                                        <img src="${avatarUrl}" alt="${userName}" class="w-10 h-10 rounded-full">
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-semibold text-sm truncate">${userName}</h4>
                                            <p class="text-xs text-gray-500">${mutualFriends > 0 ? `${mutualFriends} bạn chung` : 'Có thể bạn biết'}</p>
                                        </div>
                                    </div>
                                    <button onclick="sendFriendRequest('${user._id || user.id}')" 
                                            class="px-3 py-1 bg-blue-500 text-white text-xs rounded-full hover:bg-blue-600 transition">
                                        Kết bạn
                                    </button>
                                </div>
                            `;
                        }).join('');
                        
                        suggestionsContainer.innerHTML = suggestionsHTML;
                    } else {
                        suggestionsContainer.innerHTML = `
                            <div class="text-center py-4 text-gray-500">
                                <i data-lucide="users" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm">Chưa có gợi ý bạn bè</p>
                            </div>
                        `;
                        lucide.createIcons();
                    }
                } else {
                    console.error('Failed to load friend suggestions');
                }
            } catch (error) {
                console.error('Error loading friend suggestions:', error);
            }
        }

        // Load trending topics
        async function loadTrendingTopics() {
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                const response = await fetch('/api/posts/trending', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const trendingContainer = document.getElementById('trending-topics');
                    
                    if (data.success && data.trending && data.trending.length > 0) {
                        const trendingHTML = data.trending.slice(0, 5).map((topic, index) => {
                            const trendingIcon = index === 0 ? '🔥' : index === 1 ? '⚡' : index === 2 ? '🌟' : '📈';
                            
                            return `
                                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg transition cursor-pointer" onclick="searchHashtag('${topic.hashtag}')">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-lg">${trendingIcon}</span>
                                        <div>
                                            <h4 class="font-semibold text-sm text-blue-600">#${topic.hashtag}</h4>
                                            <p class="text-xs text-gray-500">${topic.count} bài viết</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center text-xs text-gray-400">
                                        <i data-lucide="trending-up" class="w-3 h-3 mr-1"></i>
                                        ${topic.trend || 'HOT'}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        trendingContainer.innerHTML = trendingHTML;
                        lucide.createIcons();
                    } else {
                        // Fallback - hiển thị trending topics mặc định từ hoạt động thực tế
                        const fallbackTopics = [
                            { hashtag: 'CowSocialNetwork', count: Math.floor(Math.random() * 50) + 20, trend: 'HOT' },
                            { hashtag: 'SinhVien', count: Math.floor(Math.random() * 30) + 15, trend: 'TĂNG' },
                            { hashtag: 'CongNghe', count: Math.floor(Math.random() * 25) + 10, trend: 'HOT' },
                            { hashtag: 'TinTuc', count: Math.floor(Math.random() * 20) + 8, trend: 'TĂNG' },
                            { hashtag: 'GiaiTri', count: Math.floor(Math.random() * 15) + 5, trend: 'TĂNG' }
                        ];
                        
                        const trendingHTML = fallbackTopics.map((topic, index) => {
                            const trendingIcon = index === 0 ? '🔥' : index === 1 ? '⚡' : index === 2 ? '🌟' : '📈';
                            
                            return `
                                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg transition cursor-pointer" onclick="searchHashtag('${topic.hashtag}')">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-lg">${trendingIcon}</span>
                                        <div>
                                            <h4 class="font-semibold text-sm text-blue-600">#${topic.hashtag}</h4>
                                            <p class="text-xs text-gray-500">${topic.count} bài viết</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center text-xs text-gray-400">
                                        <i data-lucide="trending-up" class="w-3 h-3 mr-1"></i>
                                        ${topic.trend}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        trendingContainer.innerHTML = trendingHTML;
                        lucide.createIcons();
                    }
                } else {
                    console.error('Failed to load trending topics');
                }
            } catch (error) {
                console.error('Error loading trending topics:', error);
            }
        }

        // Search hashtag function
        window.searchHashtag = function(hashtag) {
            const searchInput = document.getElementById('header-search');
            if (searchInput) {
                searchInput.value = `#${hashtag}`;
                searchInput.focus();
                // Trigger search
                searchInput.dispatchEvent(new Event('input'));
            }
        };

        // Send friend request function (global)
        window.sendFriendRequest = async function(userId) {
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ recipientId: userId })
                });

                if (response.ok) {
                    showNotification('Đã gửi lời mời kết bạn!', 'success');
                    // Reload friend suggestions để cập nhật UI
                    setTimeout(loadFriendSuggestions, 1000);
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Lỗi khi gửi lời mời kết bạn', 'error');
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                showNotification('Lỗi khi gửi lời mời kết bạn', 'error');
            }
        };

        // View user profile function (global)
        window.viewUserProfile = function(userId) {
            if (!userId || userId === 'undefined' || userId === 'null') {
                console.error('Invalid userId provided:', userId);
                return;
            }
            
            const profileUrl = `/profile?user=${encodeURIComponent(userId)}`;
            window.location.href = profileUrl;
        };
    </script>
</body>
</html>
