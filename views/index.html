<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang ch·ªß - Cow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            overflow-x: hidden;
            visibility: hidden; /* ·∫®n body cho ƒë·∫øn khi ki·ªÉm tra xong */
        }
        
        /* Ch·ªâ hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p */
        body.authenticated {
            visibility: visible;
        }
        
        /* User name styling cho xu·ªëng d√≤ng */
        #user-name {
            line-height: 1.2;
            font-size: 1.125rem; /* text-lg equivalent */
            max-width: 160px;
        }
        
        /* --- T√ôY CH·ªàNH THANH CU·ªòN --- */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* --- TOOLTIP T√ôY CH·ªàNH --- */
        .custom-tooltip {
            position: relative;
        }
        
        .custom-tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            z-index: 1000;
            pointer-events: none;
        }
        
        .custom-tooltip::after {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        
        .custom-tooltip:hover::before,
        .custom-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-2px);
        }

        /* Hi·ªáu ·ª©ng cho n√∫t like */
        .like-button.liked svg {
            fill: #ef4444;
            stroke: #ef4444;
            transform: scale(1.1);
        }
        .like-button svg {
            transition: all 0.2s ease-in-out;
        }

        /* Keyframes cho hi·ªáu ·ª©ng xu·∫•t hi·ªán */
        @keyframes fadeIn-Up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeIn-Up 0.6s ease-out forwards;
        }
        
        /* Transition cho menu t√πy ch·ªçn */
        .post-options-menu {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header ch√≠nh -->
    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40">
        <div class="relative flex items-center justify-between h-16 px-4">
            <!-- C·ªôt Tr√°i: Logo v√† Thanh t√¨m ki·∫øm -->
            <div class="flex items-center space-x-2">
                <div class="flex-shrink-0">
                    <a href="/" class="block" title="V·ªÅ trang ch·ªß">
                        <svg class="w-10 h-10 text-black hover:text-gray-700 transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2.5 13.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm5 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-5H8v-2h8v2z"/><path d="M19.36 8.64C18.48 7.52 17.3 6.66 16 6.18V4.05c1.73.64 3.22 1.76 4.36 3.14l-1 1.45zM4.64 8.64l-1-1.45C4.78 5.81 6.27 4.69 8 4.05v2.13c-1.3.48-2.48 1.34-3.36 2.46z"/><path d="M12 18c-2.21 0-4-1.79-4-4h8c0 2.21-1.79 4-4 4z" opacity=".5"/></svg>
                    </a>
                </div>
                <div class="relative hidden lg:block">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                    </span>
                    <input 
                        id="header-search" 
                        type="search" 
                        placeholder="T√¨m ki·∫øm b·∫°n b√®..." 
                        class="w-full pl-10 pr-4 py-2 rounded-full bg-gray-100 border-transparent focus:bg-white focus:border-gray-300 focus:ring-black/50 transition"
                        autocomplete="off"
                    >
                    <!-- Dropdown k·∫øt qu·∫£ t√¨m ki·∫øm -->
                    <div id="search-dropdown" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-lg border border-gray-200 max-h-80 overflow-y-auto z-50 hidden">
                        <div id="search-results" class="p-2">
                            <!-- K·∫øt qu·∫£ t√¨m ki·∫øm s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- C·ªôt Gi·ªØa: Navigation Icons (ƒë·ªãnh v·ªã tuy·ªát ƒë·ªëi) -->
            <nav class="hidden md:flex items-center justify-center space-x-2 absolute left-1/2 -translate-x-1/2">
                <a href="/" class="p-3 rounded-full bg-gray-200 transition" title="Trang ch·ªß"><i data-lucide="home" class="w-6 h-6"></i></a>
                <a href="/messages" class="p-3 rounded-full hover:bg-gray-100 transition" title="Tin nh·∫Øn"><i data-lucide="message-square" class="w-6 h-6"></i></a>
                <a href="/notifications" class="p-3 rounded-full hover:bg-gray-100 transition relative" title="Th√¥ng b√°o">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                    <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </a>
                <a href="/friends" class="p-3 rounded-full hover:bg-gray-100 transition" title="B·∫°n b√®"><i data-lucide="users" class="w-6 h-6"></i></a>
                <a href="/profile" class="p-3 rounded-full hover:bg-gray-100 transition" title="Profile"><i data-lucide="user" class="w-6 h-6"></i></a>
            </nav>
            <!-- C·ªôt Ph·∫£i: User Profile -->
            <div class="flex items-center space-x-3">
                <!-- N·ªôi dung ƒë√£ ƒë∆∞·ª£c x√≥a -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-12 gap-6">

            <!-- Left Sidebar -->
            <aside class="hidden md:block col-span-3 animate-fade-in-up" style="animation-delay: 100ms;">
                <div class="sticky top-24 space-y-6">
                    <div class="bg-white p-4 rounded-2xl shadow-lg">
                        <div class="flex items-center space-x-4">
                            <img id="user-avatar" src="https://placehold.co/56x56/000000/FFFFFF?text=B" alt="User Avatar" class="w-14 h-14 rounded-full">
                            <div class="flex-1 min-w-0">
                                <h3 id="user-name" class="font-bold text-lg break-words leading-tight">B√≤ S·ªØa</h3>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg">
                        <nav class="space-y-2">
                            <a href="/profile" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 font-semibold"><i data-lucide="user-circle" class="w-6 h-6 text-gray-600"></i><span>H·ªì s∆°</span></a>
                            <a href="#" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 font-semibold"><i data-lucide="newspaper" class="w-6 h-6 text-gray-600"></i><span>B·∫£ng tin</span></a>
                            <a href="/settings" class="flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 font-semibold"><i data-lucide="settings" class="w-6 h-6 text-gray-600"></i><span>C√†i ƒë·∫∑t</span></a>
                            <button id="logout-btn" class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-100 font-semibold text-left transition"><i data-lucide="log-out" class="w-6 h-6 text-gray-600"></i><span>ƒêƒÉng xu·∫•t</span></button>
                        </nav>
                    </div>
                </div>
            </aside>

            <!-- Center Feed -->
            <!-- Main Content -->
            <div class="col-span-12 md:col-span-6 space-y-6 animate-fade-in-up" style="animation-delay: 200ms;">
                <!-- Create Post -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <div class="flex items-center space-x-4">
                        <img id="post-user-avatar" src="https://placehold.co/48x48/000000/FFFFFF?text=B" alt="User Avatar" class="w-12 h-12 rounded-full">
                        <div id="post-placeholder" class="flex-grow text-left px-4 py-3 bg-gray-100 rounded-full text-gray-500 cursor-pointer hover:bg-gray-200 transition">B·∫°n ƒëang nghƒ© g√¨?</div>
                    </div>
                    <div class="flex justify-around items-center mt-4 pt-4 border-t border-gray-100">
                        <button class="flex items-center space-x-2 text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg transition">
                            <i data-lucide="video" class="w-6 h-6 text-red-500"></i>
                            <span class="font-semibold">Video tr·ª±c ti·∫øp</span>
                        </button>
                        <button class="flex items-center space-x-2 text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg transition">
                            <i data-lucide="image" class="w-6 h-6 text-green-500"></i>
                            <span class="font-semibold">·∫¢nh/video</span>
                        </button>
                        <button class="flex items-center space-x-2 text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg transition">
                            <i data-lucide="smile" class="w-6 h-6 text-yellow-500"></i>
                            <span class="font-semibold">C·∫£m x√∫c</span>
                        </button>
                    </div>
                </div>

                <!-- Posts Feed -->
                <div id="posts-feed" class="space-y-6">
                    <!-- B√†i vi·∫øt s·∫Ω ƒë∆∞·ª£c load ƒë·ªông t·ª´ API -->
                    <div id="empty-posts" class="text-center py-12">
                        <i data-lucide="message-circle" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</h3>
                        <p class="text-gray-500">H√£y t·∫°o b√†i vi·∫øt ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu chia s·∫ª!</p>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <aside class="hidden lg:block col-span-3 animate-fade-in-up" style="animation-delay: 300ms;">
                <div class="sticky top-24 space-y-6">
                    <div class="bg-white p-4 rounded-2xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4">G·ª£i √Ω cho b·∫°n</h3>
                        <div id="friend-suggestions" class="space-y-4">
                            <!-- G·ª£i √Ω b·∫°n b√® s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                            <div class="text-center py-4 text-gray-500">
                                <i data-lucide="users" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm">Ch∆∞a c√≥ g·ª£i √Ω b·∫°n b√®</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4">Th·ªãnh h√†nh</h3>
                        <div id="trending-topics" class="space-y-3">
                            <!-- Hashtag th·ªãnh h√†nh s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                            <div class="text-center py-4 text-gray-500">
                                <i data-lucide="trending-up" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm">Ch∆∞a c√≥ ch·ªß ƒë·ªÅ th·ªãnh h√†nh</p>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

        </div>
    </main>

    <!-- Modal T·∫°o b√†i vi·∫øt -->
    <div id="create-post-modal" class="fixed inset-0 z-[9999] hidden items-center justify-center" style="background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">T·∫°o b√†i vi·∫øt</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div class="p-4">
                <!-- User Info -->
                <div class="flex items-center space-x-3 mb-4">
                    <img id="modal-user-avatar" src="https://placehold.co/48x48/000000/FFFFFF?text=B" alt="User Avatar" class="w-12 h-12 rounded-full">
                    <div>
                        <h3 id="modal-user-name" class="font-semibold text-gray-800">Nghia Trong</h3>
                        <select class="text-sm text-gray-600 bg-gray-100 rounded px-2 py-1" title="Quy·ªÅn ri√™ng t∆∞">
                            <option>üåê C√¥ng khai</option>
                            <option>üë• B·∫°n b√®</option>
                            <option>üîí Ch·ªâ m√¨nh t√¥i</option>
                        </select>
                    </div>
                </div>
                
                <!-- Post Content -->
                <textarea id="modal-post-content" class="w-full p-3 border-0 resize-none text-lg placeholder-gray-500 focus:outline-none" 
                    placeholder="B·∫°n ƒëang nghƒ© g√¨?" rows="6"></textarea>
                
                <!-- Action Buttons -->
                <div class="flex items-center justify-between mt-4 p-3 border border-gray-200 rounded-lg">
                    <span class="text-sm font-semibold text-gray-700">Th√™m v√†o b√†i vi·∫øt c·ªßa b·∫°n</span>
                    <div class="flex items-center space-x-2">
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="·∫¢nh/Video">
                            <i data-lucide="image" class="w-6 h-6 text-green-500"></i>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="G·∫Øn th·∫ª b·∫°n b√®">
                            <i data-lucide="users" class="w-6 h-6 text-blue-500"></i>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="C·∫£m x√∫c">
                            <i data-lucide="smile" class="w-6 h-6 text-yellow-500"></i>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="V·ªã tr√≠">
                            <i data-lucide="map-pin" class="w-6 h-6 text-red-500"></i>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="GIF">
                            <span class="text-sm font-bold text-purple-500">GIF</span>
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition" title="Th√™m">
                            <i data-lucide="more-horizontal" class="w-6 h-6 text-gray-500"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Post Button -->
                <button id="modal-post-btn" class="w-full mt-4 py-3 bg-gray-300 text-gray-500 font-bold rounded-lg cursor-not-allowed transition" disabled>
                    ƒêƒÉng
                </button>
            </div>
        </div>
    </div>

    <!-- Modal X√°c nh·∫≠n ƒëƒÉng xu·∫•t -->
    <div id="logout-modal" class="fixed inset-0 z-[9999] hidden items-center justify-center" style="background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <!-- Header -->
            <div class="p-6 text-center">
                <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                    <i data-lucide="log-out" class="w-8 h-8 text-red-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">X√°c nh·∫≠n ƒëƒÉng xu·∫•t</h2>
                <p class="text-gray-600">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n?</p>
            </div>
            
            <!-- Buttons -->
            <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200">
                <button id="cancel-logout" class="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition font-semibold">
                    H·ªßy
                </button>
                <button id="confirm-logout" class="px-6 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg transition font-semibold">
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </div>

    <script>
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p ngay l·∫≠p t·ª©c - kh√¥ng c√≥ delay
        const userInfo = localStorage.getItem('userInfo');
        
        // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn h∆∞·ªõng ngay l·∫≠p t·ª©c
        if (!userInfo) {
            window.location.replace('/login');
        } else {
            // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa th√¥ng tin ƒëƒÉng nh·∫≠p
            try {
                const parsedUserInfo = JSON.parse(userInfo);
                if (!parsedUserInfo.firstName || !parsedUserInfo.loginTime) {
                    // Th√¥ng tin kh√¥ng h·ª£p l·ªá, x√≥a v√† chuy·ªÉn v·ªÅ login
                    localStorage.removeItem('userInfo');
                    window.location.replace('/login');
                } else {
                    // Ki·ªÉm tra th·ªùi gian ƒëƒÉng nh·∫≠p (session timeout: 24h)
                    const loginTime = new Date(parsedUserInfo.loginTime);
                    const now = new Date();
                    const timeDiff = now - loginTime;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        // Session h·∫øt h·∫°n
                        localStorage.removeItem('userInfo');
                        window.location.replace('/login');
                    } else {
                        // ƒêƒÉng nh·∫≠p h·ª£p l·ªá, hi·ªÉn th·ªã trang
                        document.body.classList.add('authenticated');
                    }
                }
            } catch (error) {
                // L·ªói parse JSON, x√≥a v√† chuy·ªÉn v·ªÅ login
                localStorage.removeItem('userInfo');
                window.location.replace('/login');
            }
        }
        
        lucide.createIcons();

        // C·∫•u h√¨nh API
        const API_BASE = 'http://localhost:3000/api';

        // H√†m t·∫°o avatar t·ª´ ch·ªØ c√°i ƒë·∫ßu
        function createAvatarUrl(name, size = 48) {
            const firstLetter = name.charAt(0).toUpperCase();
            const colors = ['4CAF50', 'E91E63', '3F51B5', 'FF9800', '9C27B0', 'F44336', '00BCD4', 'FFEB3B'];
            const color = colors[name.charCodeAt(0) % colors.length];
            return `https://placehold.co/${size}x${size}/${color}/FFFFFF?text=${firstLetter}`;
        }

        // H√†m format th·ªùi gian
        function formatTime(timestamp) {
            const now = new Date();
            const postTime = new Date(timestamp);
            const diff = Math.floor((now - postTime) / 1000);
            
            if (diff < 60) return 'V·ª´a xong';
            if (diff < 3600) return `${Math.floor(diff / 60)} ph√∫t tr∆∞·ªõc`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} gi·ªù tr∆∞·ªõc`;
            return `${Math.floor(diff / 86400)} ng√†y tr∆∞·ªõc`;
        }

        // H√†m t·∫°o HTML cho b√†i vi·∫øt
        function createPostHTML(post) {
            const authorName = post.author ? `${post.author.firstName} ${post.author.lastName}` : 'Unknown User';
            const authorKey = post.author ? `${post.author.firstName}_${post.author.lastName}` : 'unknown';
            return `
                <div class="post-card bg-white p-5 rounded-2xl shadow-lg transition-shadow duration-300 hover:shadow-2xl" data-post-id="${post._id}">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <img src="${createAvatarUrl(authorKey)}" alt="User Avatar" class="w-12 h-12 rounded-full">
                            <div>
                                <h4 class="font-bold">${authorName}</h4>
                                <p class="text-sm text-gray-500">${formatTime(post.createdAt)}</p>
                            </div>
                        </div>
                        <div class="relative">
                            <button class="post-options-btn p-2 rounded-full hover:bg-gray-100">
                                <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                            </button>
                            <div class="post-options-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-10 origin-top-right">
                                <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="bookmark" class="w-4 h-4 mr-2"></i>L∆∞u b√†i vi·∫øt</a>
                                <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="eye-off" class="w-4 h-4 mr-2"></i>·∫®n b√†i vi·∫øt</a>
                                <a href="#" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-gray-100"><i data-lucide="flag" class="w-4 h-4 mr-2"></i>B√°o c√°o</a>
                            </div>
                        </div>
                    </div>
                    <p class="mb-4 text-lg">${post.content}</p>
                    ${post.image ? `<img src="${post.image}" alt="Post Image" class="rounded-xl w-full mb-4">` : ''}
                    <div class="flex justify-between items-center mt-4 text-gray-500">
                       <button class="like-button custom-tooltip flex items-center space-x-2 hover:text-red-500 transition-transform hover:scale-110 ${post.likes && post.likes.length > 0 ? 'liked' : ''}" data-tooltip="Th√≠ch">
                           <i data-lucide="heart" class="w-6 h-6"></i>
                           <span class="font-semibold">${post.likes ? post.likes.length : 0}</span>
                       </button>
                       <button class="custom-tooltip flex items-center space-x-2 hover:text-blue-500 transition-transform hover:scale-110" data-tooltip="B√¨nh lu·∫≠n">
                           <i data-lucide="message-circle" class="w-6 h-6"></i>
                           <span class="font-semibold">${post.comments ? post.comments.length : 0}</span>
                       </button>
                       <button class="custom-tooltip flex items-center space-x-2 hover:text-green-500 transition-transform hover:scale-110" data-tooltip="Chia s·∫ª">
                           <i data-lucide="share-2" class="w-6 h-6"></i>
                           <span>Chia s·∫ª</span>
                       </button>
                    </div>
                </div>
            `;
        }

        // H√†m load b√†i vi·∫øt t·ª´ API
        async function loadPosts() {
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                console.log('LoadPosts: Token check:', token ? 'exists' : 'missing');
                
                if (!token) {
                    console.log('LoadPosts: No token found, redirecting to login');
                    // Th√™m delay ƒë·ªÉ tr√°nh conflict
                    setTimeout(() => {
                        if (!window.location.pathname.includes('login')) {
                            window.location.href = '/login';
                        }
                    }, 100);
                    return;
                }

                console.log('LoadPosts: Fetching posts...');
                const response = await fetch('/api/posts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('LoadPosts: API response status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('LoadPosts: Token expired, clearing and redirecting');
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('token');
                        localStorage.removeItem('userInfo');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 100);
                        return;
                    }
                    throw new Error(`Failed to fetch posts: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('LoadPosts: Posts loaded:', data.posts?.length || 0);
                const posts = data.posts || [];
                
                const postsFeed = document.getElementById('posts-feed');
                const emptyPosts = document.getElementById('empty-posts');
                
                if (posts.length === 0) {
                    emptyPosts.style.display = 'block';
                    postsFeed.innerHTML = '';
                } else {
                    emptyPosts.style.display = 'none';
                    postsFeed.innerHTML = posts.map(post => createPostHTML(post)).join('');
                    
                    // T√°i t·∫°o icons sau khi th√™m HTML m·ªõi
                    lucide.createIcons();
                    
                    // G·∫Øn l·∫°i tooltips
                    attachTooltips();
                }
            } catch (error) {
                console.error('LoadPosts: Error loading posts:', error);
                
                // Ch·ªâ clear v√† redirect n·∫øu l√† l·ªói authentication
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    console.log('LoadPosts: Authentication error, clearing storage and redirecting');
                    localStorage.removeItem('token');
                    localStorage.removeItem('userInfo');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 100);
                } else {
                    // L·ªói kh√°c, hi·ªÉn th·ªã th√¥ng b√°o m√† kh√¥ng redirect
                    console.log('LoadPosts: Network or other error, showing message');
                    const postsFeed = document.getElementById('posts-feed');
                    if (postsFeed) {
                        postsFeed.innerHTML = '<div class="text-center text-red-500 p-4">Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt. Vui l√≤ng th·ª≠ l·∫°i sau.</div>';
                    }
                }
            }
        }

        // H√†m t·∫°o b√†i vi·∫øt m·ªõi
        async function createPost(content) {
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return false;
                }

                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        content: content,
                        privacy: 'public'
                    })
                });
                
                if (response.ok) {
                    // Reload b√†i vi·∫øt sau khi t·∫°o
                    await loadPosts();
                    return true;
                } else {
                    const error = await response.json();
                    alert('L·ªói khi t·∫°o b√†i vi·∫øt: ' + (error.error || 'Unknown error'));
                    return false;
                }
            } catch (error) {
                console.error('L·ªói khi t·∫°o b√†i vi·∫øt:', error);
                alert('L·ªói khi t·∫°o b√†i vi·∫øt');
                return false;
            }
        }

        // H√†m like/unlike b√†i vi·∫øt
        async function toggleLike(postId) {
            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/like`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Reload b√†i vi·∫øt ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë like
                    await loadPosts();
                }
            } catch (error) {
                console.error('L·ªói khi like b√†i vi·∫øt:', error);
            }
        }

        window.onload = function() {
            console.log('Index page: Page loaded, checking authentication...');
            
            // Check authentication tr∆∞·ªõc
            const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            
            console.log('Index page: Token exists:', !!token);
            console.log('Index page: UserInfo exists:', !!userInfo);
            
            if (!token || !userInfo) {
                console.log('Index page: Missing authentication, redirecting to login...');
                // Ch·ªâ redirect n·∫øu kh√¥ng ph·∫£i ƒëang ·ªü trang login
                if (!window.location.pathname.includes('login')) {
                    // Delay nh·ªè ƒë·ªÉ tr√°nh conflict v·ªõi login page
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 100);
                }
                return;
            }
            
            console.log('Index page: Authentication found, initializing page...');
            
            const postsFeed = document.getElementById('posts-feed');
            const createPostModal = document.getElementById('create-post-modal');
            const postPlaceholder = document.getElementById('post-placeholder');
            const closeModal = document.getElementById('close-modal');
            const modalPostContent = document.getElementById('modal-post-content');
            const modalPostBtn = document.getElementById('modal-post-btn');
            
            // Elements cho logout modal
            const logoutBtn = document.getElementById('logout-btn');
            const logoutModal = document.getElementById('logout-modal');
            const cancelLogout = document.getElementById('cancel-logout');
            const confirmLogout = document.getElementById('confirm-logout');
            
            // Test token v√† load posts
            console.log('Index page: Testing token and loading posts...');
            loadPosts();
            
            // X·ª≠ l√Ω ch·ª©c nƒÉng ƒëƒÉng xu·∫•t
            logoutBtn.addEventListener('click', function() {
                logoutModal.classList.remove('hidden');
                logoutModal.classList.add('flex');
            });
            
            // H·ªßy ƒëƒÉng xu·∫•t
            cancelLogout.addEventListener('click', function() {
                logoutModal.classList.add('hidden');
                logoutModal.classList.remove('flex');
            });
            
            // X√°c nh·∫≠n ƒëƒÉng xu·∫•t
            confirmLogout.addEventListener('click', function() {
                // X√≥a t·∫•t c·∫£ th√¥ng tin ng∆∞·ªùi d√πng kh·ªèi localStorage
                localStorage.removeItem('userInfo');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('token');
                
                // Hi·ªÉn th·ªã th√¥ng b√°o ƒëƒÉng xu·∫•t th√†nh c√¥ng
                alert('ƒêƒÉng xu·∫•t th√†nh c√¥ng!');
                
                // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p ho·∫∑c reload trang
                // ·ªû ƒë√¢y c√≥ th·ªÉ chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang login n·∫øu c√≥
                window.location.href = '/login';  // ho·∫∑c window.location.reload();
            });
            
            // ƒê√≥ng logout modal khi click ra ngo√†i
            logoutModal.addEventListener('click', function(e) {
                if (e.target === logoutModal) {
                    cancelLogout.click();
                }
            });
            
            // M·ªü modal khi nh·∫•n v√†o "B·∫°n ƒëang nghƒ© g√¨"
            postPlaceholder.addEventListener('click', function() {
                createPostModal.classList.remove('hidden');
                createPostModal.classList.add('flex');
                modalPostContent.focus();
            });
            
            // ƒê√≥ng modal khi nh·∫•n n√∫t X
            closeModal.addEventListener('click', function() {
                createPostModal.classList.add('hidden');
                createPostModal.classList.remove('flex');
                modalPostContent.value = '';
                modalPostBtn.disabled = true;
                modalPostBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                modalPostBtn.classList.remove('bg-black', 'text-white', 'hover:bg-gray-800');
            });
            
            // ƒê√≥ng modal khi nh·∫•n ra ngo√†i
            createPostModal.addEventListener('click', function(e) {
                if (e.target === createPostModal) {
                    closeModal.click();
                }
            });
            
            // K√≠ch ho·∫°t n√∫t ƒêƒÉng khi c√≥ n·ªôi dung
            modalPostContent.addEventListener('input', function() {
                if (this.value.trim()) {
                    modalPostBtn.disabled = false;
                    modalPostBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    modalPostBtn.classList.add('bg-black', 'text-white', 'hover:bg-gray-800');
                } else {
                    modalPostBtn.disabled = true;
                    modalPostBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    modalPostBtn.classList.remove('bg-black', 'text-white', 'hover:bg-gray-800');
                }
            });
            
            // X·ª≠ l√Ω khi nh·∫•n n√∫t ƒêƒÉng
            modalPostBtn.addEventListener('click', async function() {
                const content = modalPostContent.value.trim();
                if (content) {
                    const success = await createPost(content);
                    if (success) {
                        closeModal.click();
                    }
                }
            });
            
            // Logic m·ªü/ƒë√≥ng menu t√πy ch·ªçn
            document.body.addEventListener('click', function(e) {
                const isOptionsBtn = e.target.closest('.post-options-btn');
                
                // ƒê√≥ng t·∫•t c·∫£ c√°c menu kh√°c
                document.querySelectorAll('.post-options-menu').forEach(menu => {
                    if (!isOptionsBtn || !menu.previousElementSibling.isEqualNode(isOptionsBtn)) {
                        menu.classList.add('hidden');
                        menu.classList.remove('opacity-100', 'scale-100');
                        menu.classList.add('opacity-0', 'scale-95');
                    }
                });

                if (isOptionsBtn) {
                    const menu = isOptionsBtn.nextElementSibling;
                    const isHidden = menu.classList.toggle('hidden');
                    if (!isHidden) {
                         // D√πng setTimeout ƒë·ªÉ tr√¨nh duy·ªát k·ªãp render tr∆∞·ªõc khi transition
                        setTimeout(() => {
                            menu.classList.remove('opacity-0', 'scale-95');
                            menu.classList.add('opacity-100', 'scale-100');
                        }, 10);
                    }
                }
            });

            // Logic cho c√°c h√†nh ƒë·ªông trong menu (like, delete, etc.)
            postsFeed.addEventListener('click', async function(e) {
                const likeButton = e.target.closest('.like-button');
                if (likeButton) {
                    const postCard = likeButton.closest('.post-card');
                    const postId = postCard.dataset.postId;
                    await toggleLike(postId);
                }

                const deleteButton = e.target.closest('.delete-post-btn');
                if (deleteButton) {
                    const postCard = deleteButton.closest('.post-card');
                    if (postCard) {
                        postCard.style.transition = 'opacity 0.5s ease';
                        postCard.style.opacity = '0';
                        setTimeout(() => postCard.remove(), 500);
                    }
                }
            });
            
            // Tooltip System - JavaScript Dynamic Tooltips
            function createTooltip() {
                const tooltip = document.createElement('div');
                tooltip.id = 'dynamic-tooltip';
                tooltip.style.cssText = `
                    position: absolute;
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    font-weight: 500;
                    white-space: nowrap;
                    z-index: 10000;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.2s ease;
                    transform: translateY(-5px);
                `;
                document.body.appendChild(tooltip);
                return tooltip;
            }
            
            function showTooltip(element, text) {
                let tooltip = document.getElementById('dynamic-tooltip');
                if (!tooltip) {
                    tooltip = createTooltip();
                }
                
                const rect = element.getBoundingClientRect();
                tooltip.textContent = text;
                tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 10 + window.scrollY) + 'px';
                tooltip.style.opacity = '1';
            }
            
            function hideTooltip() {
                const tooltip = document.getElementById('dynamic-tooltip');
                if (tooltip) {
                    tooltip.style.opacity = '0';
                }
            }
            
            // G·∫Øn tooltip cho c√°c button
            window.attachTooltips = function() {
                document.querySelectorAll('[data-tooltip]').forEach(element => {
                    element.addEventListener('mouseenter', function() {
                        showTooltip(this, this.getAttribute('data-tooltip'));
                    });
                    
                    element.addEventListener('mouseleave', function() {
                        hideTooltip();
                    });
                });
            }
            
            // Kh·ªüi t·∫°o tooltips khi DOM ƒë√£ s·∫µn s√†ng
            attachTooltips();

            // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng t·ª´ localStorage v√† server
            const updateUserInfo = async () => {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                if (userInfo.firstName) {
                    // Ch·ªâ s·ª≠ d·ª•ng firstName (t√™n)
                    const firstName = userInfo.firstName;
                    
                    // C·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng trong sidebar v·ªõi ch√†o m·ª´ng (xu·ªëng d√≤ng)
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.innerHTML = `Ch√†o m·ª´ng<br>${firstName}`;
                    }

                    // C·∫≠p nh·∫≠t placeholder trong post
                    const postPlaceholder = document.getElementById('post-placeholder');
                    if (postPlaceholder) {
                        postPlaceholder.textContent = `B·∫°n ƒëang nghƒ© g√¨, ${firstName}?`;
                    }
                    
                    // C·∫≠p nh·∫≠t th√¥ng tin trong modal
                    const modalUserName = document.getElementById('modal-user-name');
                    if (modalUserName) {
                        modalUserName.textContent = firstName;
                    }

                    // Load avatar t·ª´ server
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        if (token) {
                            const response = await fetch('/api/user-profile', {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (response.ok) {
                                const profile = await response.json();
                                
                                // C·∫≠p nh·∫≠t avatar n·∫øu c√≥ t·ª´ server
                                const userAvatar = document.getElementById('user-avatar');
                                const postUserAvatar = document.getElementById('post-user-avatar');
                                const modalUserAvatar = document.getElementById('modal-user-avatar');
                                
                                if (profile.avatar) {
                                    // S·ª≠ d·ª•ng avatar t·ª´ server
                                    if (userAvatar) userAvatar.src = profile.avatar;
                                    if (postUserAvatar) postUserAvatar.src = profile.avatar;
                                    if (modalUserAvatar) modalUserAvatar.src = profile.avatar;
                                } else {
                                    // Fallback v·ªÅ avatar m·∫∑c ƒë·ªãnh
                                    const firstLetter = firstName.charAt(0).toUpperCase();
                                    if (userAvatar) {
                                        userAvatar.src = `https://placehold.co/56x56/000000/FFFFFF?text=${firstLetter}`;
                                    }
                                    if (postUserAvatar) {
                                        postUserAvatar.src = `https://placehold.co/48x48/000000/FFFFFF?text=${firstLetter}`;
                                    }
                                    if (modalUserAvatar) {
                                        modalUserAvatar.src = `https://placehold.co/48x48/000000/FFFFFF?text=${firstLetter}`;
                                    }
                                }
                                return;
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load profile:', error);
                    }
                    
                    // Fallback n·∫øu kh√¥ng load ƒë∆∞·ª£c t·ª´ server
                    const firstLetter = firstName.charAt(0).toUpperCase();
                    const userAvatar = document.getElementById('user-avatar');
                    const postUserAvatar = document.getElementById('post-user-avatar');
                    const modalUserAvatar = document.getElementById('modal-user-avatar');
                    
                    if (userAvatar) {
                        userAvatar.src = `https://placehold.co/56x56/000000/FFFFFF?text=${firstLetter}`;
                    }
                    if (postUserAvatar) {
                        postUserAvatar.src = `https://placehold.co/48x48/000000/FFFFFF?text=${firstLetter}`;
                    }
                    if (modalUserAvatar) {
                        modalUserAvatar.src = `https://placehold.co/48x48/000000/FFFFFF?text=${firstLetter}`;
                    }
                }
            };

            // Header search functionality
            const initializeHeaderSearch = () => {
                const searchInput = document.getElementById('header-search');
                const searchDropdown = document.getElementById('search-dropdown');
                const searchResults = document.getElementById('search-results');
                let searchTimeout;

                if (!searchInput) return;

                // Handle search input
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    
                    clearTimeout(searchTimeout);
                    
                    if (query.length < 2) {
                        searchDropdown.classList.add('hidden');
                        return;
                    }

                    // Debounce search
                    searchTimeout = setTimeout(() => {
                        performSearch(query);
                    }, 300);
                });

                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#header-search') && !e.target.closest('#search-dropdown')) {
                        searchDropdown.classList.add('hidden');
                    }
                });

                // Perform search API call
                async function performSearch(query) {
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        
                        searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">ƒêang t√¨m ki·∫øm...</div>';
                        searchDropdown.classList.remove('hidden');

                        const response = await fetch(`/api/friends/search?q=${encodeURIComponent(query)}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Search failed');
                        }

                        const data = await response.json();
                        displaySearchResults(data.users || []);

                    } catch (error) {
                        console.error('Search error:', error);
                        searchResults.innerHTML = '<div class="p-4 text-center text-red-500">L·ªói t√¨m ki·∫øm</div>';
                    }
                }

                // Display search results
                function displaySearchResults(users) {
                    console.log('displaySearchResults called with users:', users);
                    if (users.length === 0) {
                        searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
                        return;
                    }

                    const resultsHTML = users.map(user => {
                        console.log('üßë Processing user:', {
                            id: user.id,
                            _id: user._id,
                            firstName: user.firstName,
                            lastName: user.lastName,
                            email: user.email
                        });
                        
                        const userId = user.id || user._id;
                        console.log('üìã Using userId:', userId);
                        
                        let actionButton = '';
                        
                        switch (user.friendshipStatus) {
                            case 'accepted':
                                actionButton = '<span class="text-green-600 text-sm font-medium">ƒê√£ l√† b·∫°n</span>';
                                break;
                            case 'pending':
                                if (user.friendshipPerspective === 'sent') {
                                    actionButton = '<span class="text-gray-500 text-sm">ƒê√£ g·ª≠i l·ªùi m·ªùi</span>';
                                } else {
                                    actionButton = `<button class="text-blue-500 hover:text-blue-700 text-sm font-medium" onclick="event.stopPropagation(); acceptFromHeader('${user.friendshipId}')">Ch·∫•p nh·∫≠n</button>`;
                                }
                                break;
                            default:
                                actionButton = '';
                        }

                        return `
                            <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition user-profile-link" data-user-id="${userId}">
                                <img src="${user.avatar || user.profile?.avatar || 'https://placehold.co/40x40/000000/FFFFFF?text=' + (user.firstName?.charAt(0) || user.email?.charAt(0) || 'U')}" 
                                     alt="${user.firstName || user.username}" 
                                     class="w-10 h-10 rounded-full mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-sm">${user.name || (user.firstName + ' ' + user.lastName).trim() || user.email}</div>
                                    <div class="text-gray-500 text-xs">${user.email}</div>
                                </div>
                                ${actionButton}
                            </div>
                        `;
                    }).join('');

                    searchResults.innerHTML = resultsHTML;
                    
                    // Add click event listeners to profile links
                    const profileLinks = searchResults.querySelectorAll('.user-profile-link');
                    profileLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const userId = link.getAttribute('data-user-id');
                            console.log('Profile link clicked, userId:', userId);
                            viewUserProfile(userId);
                        });
                    });
                }

                // View user profile function
                function viewUserProfile(userId) {
                    console.log('üîç viewUserProfile called with userId:', userId);
                    console.log('üîç userId type:', typeof userId);
                    console.log('üîç userId value:', JSON.stringify(userId));
                    
                    if (!userId || userId === 'undefined' || userId === 'null') {
                        console.error('‚ùå Invalid userId provided:', userId);
                        return;
                    }
                    
                    searchDropdown.classList.add('hidden');
                    searchInput.value = '';
                    
                    // Redirect to profile page with user ID
                    const profileUrl = `/profile?user=${encodeURIComponent(userId)}`;
                    console.log('üöÄ Redirecting to:', profileUrl);
                    window.location.href = profileUrl;
                }

                // Send friend request from header search
                window.sendFriendRequestFromHeader = async (userId) => {
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        
                        const response = await fetch('/api/friends/request', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ recipientId: userId })
                        });

                        if (response.ok) {
                            // Update UI - change button to "ƒê√£ g·ª≠i"
                            event.target.textContent = 'ƒê√£ g·ª≠i';
                            event.target.disabled = true;
                            event.target.classList.remove('text-blue-500', 'hover:text-blue-700');
                            event.target.classList.add('text-gray-500');
                            
                            // Show success message
                            showNotification('ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!', 'success');
                        } else {
                            throw new Error('Failed to send friend request');
                        }
                    } catch (error) {
                        console.error('Error sending friend request:', error);
                        showNotification('L·ªói khi g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n', 'error');
                    }
                };

                // Accept friend request from header search
                window.acceptFromHeader = async (friendshipId) => {
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        
                        const response = await fetch(`/api/friends/accept/${friendshipId}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            // Show success message
                            showNotification('ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n!', 'success');
                            
                            // Update UI
                            event.target.textContent = 'ƒê√£ l√† b·∫°n';
                            event.target.disabled = true;
                            event.target.classList.remove('text-blue-500', 'hover:text-blue-700');
                            event.target.classList.add('text-green-600');
                        } else {
                            throw new Error('Failed to accept friend request');
                        }
                    } catch (error) {
                        console.error('Error accepting friend request:', error);
                        showNotification('L·ªói khi ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n', 'error');
                    }
                };

                // Send friend request
                window.sendFriendRequest = async (userId) => {
                    try {
                        const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                        
                        const response = await fetch('/api/friends/request', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ recipientId: userId })
                        });

                        if (response.ok) {
                            // Update UI - change button to "ƒê√£ g·ª≠i"
                            event.target.textContent = 'ƒê√£ g·ª≠i';
                            event.target.disabled = true;
                            event.target.classList.remove('text-blue-500', 'hover:text-blue-700');
                            event.target.classList.add('text-gray-500');
                            
                            // Show success message
                            showNotification('ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!', 'success');
                        } else {
                            throw new Error('Failed to send friend request');
                        }
                    } catch (error) {
                        console.error('Error sending friend request:', error);
                        showNotification('L·ªói khi g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n', 'error');
                    }
                };

                // Show notification
                function showNotification(message, type = 'info') {
                    // T·∫°o notification element
                    const notification = document.createElement('div');
                    notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
                        type === 'success' ? 'bg-green-500 text-white' : 
                        type === 'error' ? 'bg-red-500 text-white' : 
                        'bg-blue-500 text-white'
                    }`;
                    notification.textContent = message;
                    
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full');
                    }, 100);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 300);
                    }, 3000);
                }
            };

            // G·ªçi h√†m c·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng khi trang load
            updateUserInfo();
            initializeHeaderSearch();
            loadNotificationCount();

            // Reload notification count every 30 seconds
            setInterval(loadNotificationCount, 30000);
        };

        // Load notification count
        async function loadNotificationCount() {
            try {
                const response = await fetch('/api/notifications/unread-count', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('notification-badge');
                    const count = data.count || 0;
                    
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count.toString();
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading notification count:', error);
            }
        }
    </script>
</body>
</html>
