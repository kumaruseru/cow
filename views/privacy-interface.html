<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cow Social - Privacy & Security System</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .privacy-levels {
            margin-bottom: 20px;
        }

        .privacy-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .privacy-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .privacy-option.selected {
            border-color: #667eea;
            background: #e8f0ff;
        }

        .privacy-option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .privacy-icon {
            font-size: 1.2rem;
            margin-right: 10px;
        }

        .privacy-details {
            flex: 1;
        }

        .privacy-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .privacy-description {
            font-size: 0.9rem;
            color: #666;
        }

        .audience-count {
            font-size: 0.8rem;
            color: #999;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .advanced-options {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        .friend-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .friend-item:hover {
            background: #f0f4ff;
        }

        .friend-item.selected {
            background: #e8f0ff;
            border: 1px solid #667eea;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            color: #333;
        }

        .friend-username {
            font-size: 0.9rem;
            color: #666;
        }

        .custom-lists {
            margin: 20px 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
        }

        .list-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .list-info {
            flex: 1;
        }

        .list-name {
            font-weight: 600;
            color: #333;
        }

        .list-count {
            font-size: 0.9rem;
            color: #666;
        }

        .groups-list {
            margin: 20px 0;
        }

        .group-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .group-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .group-item.selected {
            border-color: #667eea;
            background: #e8f0ff;
        }

        .group-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .group-privacy {
            font-size: 0.8rem;
            color: #666;
        }

        .privacy-settings {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .setting-info {
            flex: 1;
        }

        .setting-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .setting-description {
            font-size: 0.9rem;
            color: #666;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .status-online {
            color: #4CAF50;
            font-weight: 600;
        }

        .status-offline {
            color: #f44336;
            font-weight: 600;
        }

        .audience-preview {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }

        .audience-title {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .audience-details {
            font-size: 0.9rem;
            color: #388e3c;
        }

        .schedule-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .datetime-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
        }

        .datetime-input:focus {
            outline: none;
            border-color: #667eea;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .schedule-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔒 Cow Social Privacy & Security</h1>
            <p>Quản lý quyền riêng tư và bảo mật cho bài viết của bạn</p>
        </div>

        <div class="main-content">
            <!-- Privacy Level Selection -->
            <div class="card">
                <h3>🛡️ Mức độ riêng tư</h3>
                <div class="privacy-levels" id="privacyLevels">
                    <div class="privacy-option" data-level="public">
                        <input type="radio" name="privacy" value="public" id="privacy-public">
                        <div class="privacy-icon">🌍</div>
                        <div class="privacy-details">
                            <div class="privacy-title">Công khai</div>
                            <div class="privacy-description">Mọi người có thể xem bài viết</div>
                            <div class="audience-count">~1000+ người</div>
                        </div>
                    </div>

                    <div class="privacy-option" data-level="friends">
                        <input type="radio" name="privacy" value="friends" id="privacy-friends" checked>
                        <div class="privacy-icon">👥</div>
                        <div class="privacy-details">
                            <div class="privacy-title">Bạn bè</div>
                            <div class="privacy-description">Chỉ bạn bè có thể xem</div>
                            <div class="audience-count">~50 bạn bè</div>
                        </div>
                    </div>

                    <div class="privacy-option" data-level="close_friends">
                        <input type="radio" name="privacy" value="close_friends" id="privacy-close-friends">
                        <div class="privacy-icon">💚</div>
                        <div class="privacy-details">
                            <div class="privacy-title">Bạn thân</div>
                            <div class="privacy-description">Chỉ bạn thân mới xem được</div>
                            <div class="audience-count">~15 bạn thân</div>
                        </div>
                    </div>

                    <div class="privacy-option" data-level="specific_friends">
                        <input type="radio" name="privacy" value="specific_friends" id="privacy-specific">
                        <div class="privacy-icon">🎯</div>
                        <div class="privacy-details">
                            <div class="privacy-title">Bạn bè cụ thể</div>
                            <div class="privacy-description">Chọn bạn bè cụ thể</div>
                            <div class="audience-count">Chọn thủ công</div>
                        </div>
                    </div>

                    <div class="privacy-option" data-level="custom_list">
                        <input type="radio" name="privacy" value="custom_list" id="privacy-custom">
                        <div class="privacy-icon">📋</div>
                        <div class="privacy-details">
                            <div class="privacy-title">Danh sách tùy chỉnh</div>
                            <div class="privacy-description">Chia sẻ với danh sách tùy chỉnh</div>
                            <div class="audience-count">Theo danh sách</div>
                        </div>
                    </div>

                    <div class="privacy-option" data-level="exclude_friends">
                        <input type="radio" name="privacy" value="exclude_friends" id="privacy-exclude">
                        <div class="privacy-icon">🚫</div>
                        <div class="privacy-details">
                            <div class="privacy-title">Trừ một số bạn</div>
                            <div class="privacy-description">Tất cả bạn bè trừ một số người</div>
                            <div class="audience-count">Bạn bè - loại trừ</div>
                        </div>
                    </div>

                    <div class="privacy-option" data-level="group_only">
                        <input type="radio" name="privacy" value="group_only" id="privacy-group">
                        <div class="privacy-icon">👪</div>
                        <div class="privacy-details">
                            <div class="privacy-title">Chỉ nhóm</div>
                            <div class="privacy-description">Chỉ thành viên nhóm</div>
                            <div class="audience-count">Thành viên nhóm</div>
                        </div>
                    </div>

                    <div class="privacy-option" data-level="only_me">
                        <input type="radio" name="privacy" value="only_me" id="privacy-only-me">
                        <div class="privacy-icon">🔒</div>
                        <div class="privacy-details">
                            <div class="privacy-title">Chỉ tôi</div>
                            <div class="privacy-description">Chỉ mình tôi xem được</div>
                            <div class="audience-count">1 người</div>
                        </div>
                    </div>
                </div>

                <div class="audience-preview" id="audiencePreview">
                    <div class="audience-title">👀 Ai có thể xem bài này?</div>
                    <div class="audience-details" id="audienceDetails">Tất cả bạn bè của bạn (~50 người)</div>
                </div>
            </div>

            <!-- Friend/Group Selection -->
            <div class="card">
                <h3>👥 Chọn đối tượng</h3>
                
                <!-- Specific Friends Selection -->
                <div id="friendsSelection" style="display: none;">
                    <label>Chọn bạn bè cụ thể:</label>
                    <div class="friend-selector" id="friendsList"></div>
                </div>

                <!-- Custom Lists -->
                <div id="customListsSelection" style="display: none;">
                    <label>Chọn danh sách tùy chỉnh:</label>
                    <div class="custom-lists" id="customLists"></div>
                    <button class="btn btn-small" onclick="createNewList()">➕ Tạo danh sách mới</button>
                </div>

                <!-- Groups Selection -->
                <div id="groupsSelection" style="display: none;">
                    <label>Chọn nhóm:</label>
                    <div class="groups-list" id="groupsList"></div>
                </div>

                <!-- Exclude Friends -->
                <div id="excludeSelection" style="display: none;">
                    <label>Loại trừ những bạn này:</label>
                    <div class="friend-selector" id="excludeList"></div>
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="card">
                <h3>⚙️ Tùy chọn nâng cao</h3>
                
                <div class="advanced-options">
                    <h4>📝 Quyền tương tác</h4>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="allowComments" checked>
                            <label for="allowComments">Cho phép bình luận</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allowShares" checked>
                            <label for="allowShares">Cho phép chia sẻ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allowTags" checked>
                            <label for="allowTags">Cho phép tag</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hideFromTimeline">
                            <label for="hideFromTimeline">Ẩn khỏi timeline</label>
                        </div>
                    </div>
                </div>

                <div class="advanced-options">
                    <h4>⏰ Lập lịch đăng bài</h4>
                    <div class="schedule-options">
                        <div class="form-group">
                            <label for="scheduleTime">Đăng vào lúc:</label>
                            <input type="datetime-local" id="scheduleTime" class="datetime-input">
                        </div>
                        <div class="form-group">
                            <label for="expiryTime">Hết hạn lúc:</label>
                            <input type="datetime-local" id="expiryTime" class="datetime-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Creator -->
        <div class="card privacy-settings">
            <h3>✍️ Tạo bài viết với Privacy</h3>
            <form id="privacyPostForm">
                <div class="form-group">
                    <label for="postTitle">Tiêu đề bài viết:</label>
                    <input type="text" id="postTitle" class="form-input" placeholder="Nhập tiêu đề bài viết..." required>
                </div>
                
                <div class="form-group">
                    <label for="postContent">Nội dung:</label>
                    <textarea id="postContent" class="form-textarea" placeholder="Chia sẻ suy nghĩ của bạn..." required></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">🔒 Đăng bài với Privacy</button>
                    <button type="button" class="btn" onclick="previewAudience()">👀 Xem trước đối tượng</button>
                    <button type="button" class="btn btn-secondary" onclick="savePrivacyTemplate()">💾 Lưu mẫu Privacy</button>
                </div>
            </form>
        </div>

        <!-- Privacy Settings -->
        <div class="card privacy-settings">
            <h3>🛠️ Cài đặt Privacy chung</h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Hiển thị trạng thái online</div>
                        <div class="setting-description">Cho phép bạn bè xem khi bạn online</div>
                    </div>
                    <div class="toggle-switch active" onclick="toggleSetting(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Cho phép lời mời kết bạn</div>
                        <div class="setting-description">Người khác có thể gửi lời mời kết bạn</div>
                    </div>
                    <div class="toggle-switch active" onclick="toggleSetting(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Hiển thị trong tìm kiếm</div>
                        <div class="setting-description">Profile xuất hiện trong kết quả tìm kiếm</div>
                    </div>
                    <div class="toggle-switch active" onclick="toggleSetting(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Cho phép tag tự động</div>
                        <div class="setting-description">Bạn bè có thể tag bạn trong bài viết</div>
                    </div>
                    <div class="toggle-switch active" onclick="toggleSetting(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Hiển thị danh sách bạn bè</div>
                        <div class="setting-description">Ai có thể xem danh sách bạn bè của bạn</div>
                    </div>
                    <select class="form-select">
                        <option value="public">Công khai</option>
                        <option value="friends" selected>Bạn bè</option>
                        <option value="only_me">Chỉ tôi</option>
                    </select>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-title">Nhận tin nhắn từ</div>
                        <div class="setting-description">Ai có thể gửi tin nhắn cho bạn</div>
                    </div>
                    <select class="form-select">
                        <option value="everyone">Mọi người</option>
                        <option value="friends" selected>Bạn bè</option>
                        <option value="no_one">Không ai</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status-indicator" id="statusIndicator">
        <div id="connectionStatus" class="status-offline">🔴 Đang kết nối...</div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let selectedFriends = new Set();
        let excludedFriends = new Set();
        let selectedCustomList = null;
        let selectedGroup = null;
        let friendsData = [];
        let customListsData = [];
        let groupsData = [];

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            setupEventListeners();
            loadUserData();
            authenticateUser();
        });

        // Socket.IO initialization
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                updateConnectionStatus(true);
                console.log('Connected to privacy system');
            });
            
            socket.on('disconnect', () => {
                updateConnectionStatus(false);
            });
            
            socket.on('authenticated', (data) => {
                currentUser = data.userId;
                console.log('Authenticated as:', data.userId);
                loadPrivacyData();
            });
            
            socket.on('user_privacy_changed', (data) => {
                console.log('Privacy settings changed:', data);
                showNotification('Cài đặt riêng tư đã được cập nhật', 'success');
            });
            
            socket.on('post_privacy_changed', (data) => {
                console.log('Post privacy updated:', data);
            });
        }

        // User authentication
        function authenticateUser() {
            // Demo login
            const username = 'alice_johnson';
            const password = 'demo123';
            
            fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const token = data.data.token;
                    socket.emit('authenticate', { token });
                    showNotification('Đăng nhập thành công!', 'success');
                }
            })
            .catch(error => {
                console.error('Auth error:', error);
                showNotification('Lỗi đăng nhập', 'error');
            });
        }

        // Update connection status
        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connectionStatus');
            if (isConnected) {
                statusElement.textContent = '🟢 Đã kết nối Privacy System';
                statusElement.className = 'status-online';
            } else {
                statusElement.textContent = '🔴 Mất kết nối';
                statusElement.className = 'status-offline';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Privacy level selection
            const privacyOptions = document.querySelectorAll('.privacy-option');
            privacyOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const radio = option.querySelector('input[type="radio"]');
                    radio.checked = true;
                    updatePrivacySelection(radio.value);
                });
            });

            // Post form submission
            document.getElementById('privacyPostForm').addEventListener('submit', handlePostSubmit);
        }

        // Update privacy selection
        function updatePrivacySelection(privacyLevel) {
            // Update UI selection
            document.querySelectorAll('.privacy-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-level="${privacyLevel}"]`).classList.add('selected');

            // Show/hide relevant sections
            hideAllSelections();
            
            switch(privacyLevel) {
                case 'specific_friends':
                    document.getElementById('friendsSelection').style.display = 'block';
                    loadFriends();
                    break;
                    
                case 'custom_list':
                    document.getElementById('customListsSelection').style.display = 'block';
                    loadCustomLists();
                    break;
                    
                case 'group_only':
                    document.getElementById('groupsSelection').style.display = 'block';
                    loadGroups();
                    break;
                    
                case 'exclude_friends':
                    document.getElementById('excludeSelection').style.display = 'block';
                    loadFriendsForExclude();
                    break;
            }
            
            updateAudiencePreview(privacyLevel);
        }

        function hideAllSelections() {
            document.getElementById('friendsSelection').style.display = 'none';
            document.getElementById('customListsSelection').style.display = 'none';
            document.getElementById('groupsSelection').style.display = 'none';
            document.getElementById('excludeSelection').style.display = 'none';
        }

        // Load privacy data
        async function loadPrivacyData() {
            try {
                await Promise.all([
                    loadFriends(),
                    loadCustomLists(),
                    loadGroups()
                ]);
            } catch (error) {
                console.error('Error loading privacy data:', error);
            }
        }

        // Load friends list
        async function loadFriends() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/friends/${currentUser}`);
                const result = await response.json();
                
                if (result.success) {
                    friendsData = result.data;
                    renderFriendsList();
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        function renderFriendsList() {
            const container = document.getElementById('friendsList');
            container.innerHTML = '';
            
            friendsData.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.dataset.friendId = friend.id;
                
                const isSelected = selectedFriends.has(friend.id);
                if (isSelected) {
                    friendItem.classList.add('selected');
                }
                
                friendItem.innerHTML = `
                    <img src="${friend.avatar}" alt="${friend.displayName}" class="friend-avatar">
                    <div class="friend-info">
                        <div class="friend-name">${friend.displayName}</div>
                        <div class="friend-username">@${friend.username}</div>
                    </div>
                    <div style="margin-left: auto;">
                        ${isSelected ? '✅' : ''}
                    </div>
                `;
                
                friendItem.addEventListener('click', () => toggleFriendSelection(friend.id, friendItem));
                container.appendChild(friendItem);
            });
        }

        function toggleFriendSelection(friendId, element) {
            if (selectedFriends.has(friendId)) {
                selectedFriends.delete(friendId);
                element.classList.remove('selected');
                element.querySelector('div:last-child').textContent = '';
            } else {
                selectedFriends.add(friendId);
                element.classList.add('selected');
                element.querySelector('div:last-child').textContent = '✅';
            }
            
            updateAudiencePreview(document.querySelector('input[name="privacy"]:checked').value);
        }

        // Load custom lists
        async function loadCustomLists() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/custom-lists/${currentUser}`);
                const result = await response.json();
                
                if (result.success) {
                    customListsData = result.data;
                    renderCustomLists();
                }
            } catch (error) {
                console.error('Error loading custom lists:', error);
            }
        }

        function renderCustomLists() {
            const container = document.getElementById('customLists');
            container.innerHTML = '';
            
            customListsData.forEach(list => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.dataset.listId = list.id;
                
                listItem.innerHTML = `
                    <div class="list-color" style="background-color: ${list.color}"></div>
                    <div class="list-info">
                        <div class="list-name">${list.name}</div>
                        <div class="list-count">${list.members.length} thành viên</div>
                    </div>
                    <input type="radio" name="customList" value="${list.id}">
                `;
                
                const radio = listItem.querySelector('input[type="radio"]');
                radio.addEventListener('change', () => {
                    selectedCustomList = list.id;
                    updateAudiencePreview(document.querySelector('input[name="privacy"]:checked').value);
                });
                
                container.appendChild(listItem);
            });
        }

        // Load groups
        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                const result = await response.json();
                
                if (result.success) {
                    groupsData = result.data;
                    renderGroups();
                }
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        function renderGroups() {
            const container = document.getElementById('groupsList');
            container.innerHTML = '';
            
            groupsData.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.dataset.groupId = group.id;
                
                groupItem.innerHTML = `
                    <div class="group-icon">${group.name.charAt(0)}</div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-privacy">${group.privacy === 'public' ? '🌍 Công khai' : '🔒 Riêng tư'} • ${group.memberCount} thành viên</div>
                    </div>
                    <input type="radio" name="group" value="${group.id}">
                `;
                
                const radio = groupItem.querySelector('input[type="radio"]');
                radio.addEventListener('change', () => {
                    selectedGroup = group.id;
                    updateAudiencePreview(document.querySelector('input[name="privacy"]:checked').value);
                    
                    // Update UI
                    document.querySelectorAll('.group-item').forEach(item => item.classList.remove('selected'));
                    groupItem.classList.add('selected');
                });
                
                container.appendChild(groupItem);
            });
        }

        // Load friends for exclude option
        function loadFriendsForExclude() {
            const container = document.getElementById('excludeList');
            container.innerHTML = '';
            
            friendsData.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.dataset.friendId = friend.id;
                
                const isExcluded = excludedFriends.has(friend.id);
                if (isExcluded) {
                    friendItem.classList.add('selected');
                }
                
                friendItem.innerHTML = `
                    <img src="${friend.avatar}" alt="${friend.displayName}" class="friend-avatar">
                    <div class="friend-info">
                        <div class="friend-name">${friend.displayName}</div>
                        <div class="friend-username">@${friend.username}</div>
                    </div>
                    <div style="margin-left: auto;">
                        ${isExcluded ? '🚫' : ''}
                    </div>
                `;
                
                friendItem.addEventListener('click', () => toggleExcludeSelection(friend.id, friendItem));
                container.appendChild(friendItem);
            });
        }

        function toggleExcludeSelection(friendId, element) {
            if (excludedFriends.has(friendId)) {
                excludedFriends.delete(friendId);
                element.classList.remove('selected');
                element.querySelector('div:last-child').textContent = '';
            } else {
                excludedFriends.add(friendId);
                element.classList.add('selected');
                element.querySelector('div:last-child').textContent = '🚫';
            }
            
            updateAudiencePreview(document.querySelector('input[name="privacy"]:checked').value);
        }

        // Update audience preview
        function updateAudiencePreview(privacyLevel) {
            const detailsElement = document.getElementById('audienceDetails');
            let audienceText = '';
            
            switch(privacyLevel) {
                case 'public':
                    audienceText = 'Mọi người trên internet (~1000+ người)';
                    break;
                    
                case 'friends':
                    audienceText = `Tất cả bạn bè của bạn (~${friendsData.length} người)`;
                    break;
                    
                case 'close_friends':
                    const closeFriendsCount = friendsData.filter(f => f.closeFriend).length;
                    audienceText = `Chỉ bạn thân (~${closeFriendsCount} người)`;
                    break;
                    
                case 'specific_friends':
                    audienceText = `${selectedFriends.size} bạn bè được chọn`;
                    break;
                    
                case 'custom_list':
                    if (selectedCustomList) {
                        const list = customListsData.find(l => l.id === selectedCustomList);
                        audienceText = `Danh sách "${list.name}" (${list.members.length} người)`;
                    } else {
                        audienceText = 'Chưa chọn danh sách';
                    }
                    break;
                    
                case 'exclude_friends':
                    const remainingFriends = friendsData.length - excludedFriends.size;
                    audienceText = `${remainingFriends} bạn bè (loại trừ ${excludedFriends.size} người)`;
                    break;
                    
                case 'group_only':
                    if (selectedGroup) {
                        const group = groupsData.find(g => g.id === selectedGroup);
                        audienceText = `Thành viên nhóm "${group.name}" (${group.memberCount} người)`;
                    } else {
                        audienceText = 'Chưa chọn nhóm';
                    }
                    break;
                    
                case 'only_me':
                    audienceText = 'Chỉ bạn (1 người)';
                    break;
                    
                default:
                    audienceText = 'Chưa xác định';
            }
            
            detailsElement.textContent = audienceText;
        }

        // Handle post submission
        async function handlePostSubmit(e) {
            e.preventDefault();
            
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const privacy = document.querySelector('input[name="privacy"]:checked').value;
            
            if (!title || !content) {
                showNotification('Vui lòng nhập tiêu đề và nội dung!', 'error');
                return;
            }
            
            const postData = {
                title,
                content,
                authorId: currentUser,
                privacy,
                specificFriends: Array.from(selectedFriends),
                excludedFriends: Array.from(excludedFriends),
                customListId: selectedCustomList,
                groupId: selectedGroup,
                allowComments: document.getElementById('allowComments').checked,
                allowShares: document.getElementById('allowShares').checked,
                allowTags: document.getElementById('allowTags').checked,
                hideFromTimeline: document.getElementById('hideFromTimeline').checked,
                scheduleTime: document.getElementById('scheduleTime').value,
                expiryTime: document.getElementById('expiryTime').value
            };
            
            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Đăng bài thành công với cài đặt riêng tư!', 'success');
                    
                    // Reset form
                    document.getElementById('privacyPostForm').reset();
                    selectedFriends.clear();
                    excludedFriends.clear();
                    selectedCustomList = null;
                    selectedGroup = null;
                    
                    // Emit event
                    socket.emit('post_privacy_updated', {
                        postId: result.data.id,
                        privacy: result.data.privacy
                    });
                    
                } else {
                    showNotification('Lỗi đăng bài: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Lỗi đăng bài: ' + error.message, 'error');
            }
        }

        // Preview audience
        function previewAudience() {
            const privacy = document.querySelector('input[name="privacy"]:checked').value;
            const audienceText = document.getElementById('audienceDetails').textContent;
            
            alert(`Đối tượng xem bài viết:\n\n${audienceText}\n\nMức độ riêng tư: ${getPrivacyLevelName(privacy)}`);
        }

        function getPrivacyLevelName(level) {
            const names = {
                public: 'Công khai',
                friends: 'Bạn bè',
                close_friends: 'Bạn thân',
                specific_friends: 'Bạn bè cụ thể',
                custom_list: 'Danh sách tùy chỉnh',
                exclude_friends: 'Trừ một số bạn',
                group_only: 'Chỉ nhóm',
                only_me: 'Chỉ tôi'
            };
            return names[level] || level;
        }

        // Save privacy template
        function savePrivacyTemplate() {
            const privacy = document.querySelector('input[name="privacy"]:checked').value;
            const template = {
                privacy,
                specificFriends: Array.from(selectedFriends),
                excludedFriends: Array.from(excludedFriends),
                customListId: selectedCustomList,
                groupId: selectedGroup,
                allowComments: document.getElementById('allowComments').checked,
                allowShares: document.getElementById('allowShares').checked,
                allowTags: document.getElementById('allowTags').checked,
                hideFromTimeline: document.getElementById('hideFromTimeline').checked
            };
            
            localStorage.setItem('privacyTemplate', JSON.stringify(template));
            showNotification('Đã lưu mẫu cài đặt riêng tư!', 'success');
        }

        // Create new custom list
        function createNewList() {
            const name = prompt('Tên danh sách mới:');
            if (!name) return;
            
            const color = prompt('Màu sắc (hex code):', '#2196F3');
            
            // This would normally create a new list via API
            showNotification('Tính năng tạo danh sách mới sẽ sớm có!', 'success');
        }

        // Toggle setting
        function toggleSetting(element) {
            element.classList.toggle('active');
            
            // Emit privacy settings update
            if (socket && currentUser) {
                socket.emit('privacy_settings_updated', {
                    changes: {
                        setting: element.parentElement.querySelector('.setting-title').textContent,
                        enabled: element.classList.contains('active')
                    }
                });
            }
        }

        // Load user data
        function loadUserData() {
            // Load saved privacy template if exists
            const savedTemplate = localStorage.getItem('privacyTemplate');
            if (savedTemplate) {
                try {
                    const template = JSON.parse(savedTemplate);
                    // Apply template settings
                    if (template.privacy) {
                        document.querySelector(`#privacy-${template.privacy.replace('_', '-')}`).checked = true;
                        updatePrivacySelection(template.privacy);
                    }
                } catch (error) {
                    console.error('Error loading privacy template:', error);
                }
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
