const mongoose = require('mongoose');
const bcrypt = require('bcrypt');
require('dotenv').config();

// Import all models
const User = require('../models/SimpleUser');
const Post = require('../models/Post');
const Message = require('../models/Message');
const Notification = require('../models/Notification');
const Friend = require('../models/Friend');

// Connect to MongoDB
const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/cow_social_network');
    console.log('‚úÖ MongoDB Connected');
  } catch (error) {
    console.error('‚ùå MongoDB connection error:', error);
    process.exit(1);
  }
};

// Clear all collections
const clearDatabase = async () => {
  console.log('üóëÔ∏è  Clearing existing data...');
  
  const collections = await mongoose.connection.db.listCollections().toArray();
  const collectionNames = collections.map(c => c.name);
  
  for (const collectionName of collectionNames) {
    await mongoose.connection.db.collection(collectionName).deleteMany({});
    console.log(`   ‚úÖ Cleared ${collectionName} collection`);
  }
};

// Create organized user data structure
const createOrganizedUserData = async () => {
  console.log('üë• Creating organized user data...');
  
  const userData = [
    {
      // User 1: Admin
      profile: {
        firstName: 'Admin',
        lastName: 'User',
        email: 'admin@cow.com',
        password: 'admin123',
        bio: 'Administrator of Cow Social Network üëë',
        location: 'Ho Chi Minh City, Vietnam',
        verified: true,
        joinDate: new Date('2024-01-01'),
        avatar: null,
        cover: null,
        settings: {
          privacy: 'public',
          emailNotifications: true,
          pushNotifications: true,
          language: 'vi'
        }
      },
      posts: [
        {
          content: 'üéâ Ch√†o m·ª´ng ƒë·∫øn v·ªõi Cow Social Network! H·ªá th·ªëng m·∫°ng x√£ h·ªôi m·ªõi v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng hi·ªán ƒë·∫°i.',
          privacy: 'public',
          tags: ['welcome', 'announcement'],
          images: [],
          location: null
        },
        {
          content: 'üì¢ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:\n‚Ä¢ Upload ·∫£nh b·∫±ng c√°ch k√©o th·∫£\n‚Ä¢ Th√™m v·ªã tr√≠ cho b√†i vi·∫øt\n‚Ä¢ Nh·∫Øn tin v·ªõi b·∫°n b√®\n‚Ä¢ T∆∞∆°ng t√°c qua like v√† comment',
          privacy: 'public',
          tags: ['tutorial', 'guide'],
          images: [],
          location: null
        }
      ],
      friends: ['john@example.com', 'sarah@example.com'],
      conversations: [
        {
          with: 'john@example.com',
          messages: [
            {
              content: 'Ch√†o John! Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi platform! üëã',
              timestamp: new Date('2025-08-01T10:00:00Z'),
              sender: 'admin'
            },
            {
              content: 'C·∫£m ∆°n Admin! Platform tr√¥ng r·∫•t tuy·ªát v·ªùi! üòä',
              timestamp: new Date('2025-08-01T10:05:00Z'),
              sender: 'recipient'
            }
          ]
        }
      ],
      notifications: [
        {
          type: 'system',
          message: 'Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Cow Social Network!',
          read: true,
          data: { type: 'welcome' }
        }
      ]
    },
    
    {
      // User 2: John Doe - Developer
      profile: {
        firstName: 'John',
        lastName: 'Doe',
        email: 'john@example.com',
        password: '123456',
        bio: 'Full-stack Developer üíª | React & Node.js enthusiast | Coffee lover ‚òï',
        location: 'District 1, Ho Chi Minh City',
        verified: false,
        joinDate: new Date('2025-01-15'),
        avatar: null,
        cover: null,
        settings: {
          privacy: 'public',
          emailNotifications: true,
          pushNotifications: true,
          language: 'en'
        }
      },
      posts: [
        {
          content: 'V·ª´a ho√†n th√†nh m·ªôt d·ª± √°n React m·ªõi! üöÄ Component architecture th·ª±c s·ª± s·∫°ch v√† d·ªÖ maintain. #coding #react #javascript',
          privacy: 'public',
          tags: ['coding', 'react', 'javascript'],
          images: [],
          location: {
            name: 'Saigon Skydeck',
            address: 'Bitexco Financial Tower, Ho Chi Minh City, Vietnam',
            lat: 10.7714,
            lng: 106.7044
          }
        },
        {
          content: 'Coffee break time! ‚òï Ai c√≥ g·ª£i √Ω coffee shop n√†o ngon ·ªü S√†i G√≤n kh√¥ng? #coffee #saigon',
          privacy: 'public',
          tags: ['coffee', 'saigon', 'break'],
          images: [],
          location: null
        },
        {
          content: 'ƒêang h·ªçc th√™m v·ªÅ Node.js performance optimization. C√≥ ai c√≥ kinh nghi·ªám v·ªÅ clustering kh√¥ng? ü§î',
          privacy: 'friends',
          tags: ['nodejs', 'performance', 'question'],
          images: [],
          location: null
        }
      ],
      friends: ['admin@cow.com', 'jane@example.com', 'sarah@example.com'],
      conversations: [
        {
          with: 'jane@example.com',
          messages: [
            {
              content: 'Hey Jane! B·∫°n c√≥ th·ªÉ review UI mockup m·ªõi kh√¥ng?',
              timestamp: new Date('2025-08-02T14:30:00Z'),
              sender: 'john'
            },
            {
              content: 'Ch·∫Øc ch·∫Øn r·ªìi! G·ª≠i link cho t√¥i nh√© üòä',
              timestamp: new Date('2025-08-02T14:35:00Z'),
              sender: 'recipient'
            }
          ]
        }
      ],
      notifications: [
        {
          type: 'like',
          message: 'Jane Smith ƒë√£ th√≠ch b√†i vi·∫øt c·ªßa b·∫°n',
          fromUser: 'jane@example.com',
          read: false,
          data: { postIndex: 0 }
        },
        {
          type: 'comment',
          message: 'Admin ƒë√£ b√¨nh lu·∫≠n v·ªÅ b√†i vi·∫øt c·ªßa b·∫°n',
          fromUser: 'admin@cow.com',
          read: false,
          data: { postIndex: 1 }
        }
      ]
    },
    
    {
      // User 3: Jane Smith - Designer
      profile: {
        firstName: 'Jane',
        lastName: 'Smith',
        email: 'jane@example.com',
        password: '123456',
        bio: 'UI/UX Designer üé® | Creating beautiful & functional interfaces | Figma expert',
        location: 'District 3, Ho Chi Minh City',
        verified: false,
        joinDate: new Date('2025-02-01'),
        avatar: null,
        cover: null,
        settings: {
          privacy: 'public',
          emailNotifications: true,
          pushNotifications: false,
          language: 'en'
        }
      },
      posts: [
        {
          content: 'Ho√†ng h√¥n tuy·ªát ƒë·∫πp t·ª´ c·ª≠a s·ªï vƒÉn ph√≤ng h√¥m nay üåÖ ƒê√¥i khi c·∫£m h·ª©ng t·ªët nh·∫•t ƒë·∫øn t·ª´ thi√™n nhi√™n!',
          privacy: 'public',
          tags: ['sunset', 'inspiration', 'office'],
          images: [],
          location: null
        },
        {
          content: 'ƒêang l√†m vi·ªác v·ªõi m·ªôt s·ªë UI mockup m·ªõi. Clean design l√† ch√¨a kh√≥a cho UX tuy·ªát v·ªùi! ‚ú® #design #ui #ux',
          privacy: 'friends',
          tags: ['design', 'ui', 'ux'],
          images: [],
          location: null
        },
        {
          content: 'Design tip c·ªßa ng√†y: Lu√¥n nghƒ© v·ªÅ user journey tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu thi·∫øt k·∫ø giao di·ªán! üéØ',
          privacy: 'public',
          tags: ['design', 'tips', 'ux'],
          images: [],
          location: null
        }
      ],
      friends: ['john@example.com', 'mike@example.com'],
      conversations: [
        {
          with: 'mike@example.com',
          messages: [
            {
              content: 'Hi Mike! T√¥i th√≠ch post marketing tips c·ªßa b·∫°n! üëç',
              timestamp: new Date('2025-08-02T16:00:00Z'),
              sender: 'jane'
            },
            {
              content: 'C·∫£m ∆°n Jane! T√¥i s·∫Ω c√≥ th√™m nhi·ªÅu tips n·ªØa s·ªõm th√¥i üòä',
              timestamp: new Date('2025-08-02T16:10:00Z'),
              sender: 'recipient'
            }
          ]
        }
      ],
      notifications: [
        {
          type: 'friend_request',
          message: 'Mike Johnson ƒë√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n',
          fromUser: 'mike@example.com',
          read: true,
          data: { status: 'accepted' }
        }
      ]
    },
    
    {
      // User 4: Mike Johnson - Marketer
      profile: {
        firstName: 'Mike',
        lastName: 'Johnson',
        email: 'mike@example.com',
        password: '123456',
        bio: 'Digital Marketing Expert üìä | Content Creator | SEO Specialist | Growth Hacker',
        location: 'District 7, Ho Chi Minh City',
        verified: false,
        joinDate: new Date('2025-02-15'),
        avatar: null,
        cover: null,
        settings: {
          privacy: 'public',
          emailNotifications: true,
          pushNotifications: true,
          language: 'en'
        }
      },
      posts: [
        {
          content: 'Digital marketing tip: Lu√¥n A/B test campaigns c·ªßa b·∫°n! üìä Quy·∫øt ƒë·ªãnh d·ª±a tr√™n data s·∫Ω mang l·∫°i k·∫øt qu·∫£ t·ªët h∆°n. #marketing #tips #data',
          privacy: 'public',
          tags: ['marketing', 'tips', 'data'],
          images: [],
          location: null
        },
        {
          content: 'Content is king, but distribution is queen! üëë B·∫°n c√≥ th·ªÉ t·∫°o content tuy·ªát v·ªùi nh∆∞ng n·∫øu kh√¥ng c√≥ strategy ph√¢n ph·ªëi th√¨ c≈©ng v√¥ √≠ch.',
          privacy: 'public',
          tags: ['content', 'marketing', 'strategy'],
          images: [],
          location: null
        }
      ],
      friends: ['jane@example.com', 'sarah@example.com'],
      conversations: [],
      notifications: [
        {
          type: 'like',
          message: 'Sarah Wilson ƒë√£ th√≠ch b√†i vi·∫øt c·ªßa b·∫°n',
          fromUser: 'sarah@example.com',
          read: false,
          data: { postIndex: 0 }
        }
      ]
    },
    
    {
      // User 5: Sarah Wilson - Photographer
      profile: {
        firstName: 'Sarah',
        lastName: 'Wilson',
        email: 'sarah@example.com',
        password: '123456',
        bio: 'Travel Photographer üì∏ | Capturing moments around Vietnam | Instagram: @sarahwilson_vn',
        location: 'Nha Trang, Vietnam',
        verified: false,
        joinDate: new Date('2025-03-01'),
        avatar: null,
        cover: null,
        settings: {
          privacy: 'public',
          emailNotifications: false,
          pushNotifications: true,
          language: 'en'
        }
      },
      posts: [
        {
          content: 'Kh√°m ph√° nh·ªØng ng√¥i ƒë·ªÅn c·ªï ·ªü H·ªôi An. Ki·∫øn tr√∫c ·ªü ƒë√¢y th·ª±c s·ª± tuy·ªát ƒë·∫πp! üèõÔ∏è #hoian #travel #photography',
          privacy: 'public',
          tags: ['hoian', 'travel', 'photography'],
          images: [],
          location: {
            name: 'Hoi An Ancient Town',
            address: 'Hoi An, Quang Nam, Vietnam',
            lat: 15.8801,
            lng: 108.3380
          }
        },
        {
          content: 'Photography tip: Golden hour l√† ng∆∞·ªùi b·∫°n t·ªët nh·∫•t cho outdoor portraits! üì∏‚ú® #photography #tips',
          privacy: 'public',
          tags: ['photography', 'tips', 'golden-hour'],
          images: [],
          location: null
        },
        {
          content: 'Nha Trang sunrise this morning was absolutely magical! üåÖ Sometimes you have to wake up early for the best shots.',
          privacy: 'friends',
          tags: ['nhatrang', 'sunrise', 'photography'],
          images: [],
          location: null
        }
      ],
      friends: ['admin@cow.com', 'john@example.com', 'mike@example.com'],
      conversations: [
        {
          with: 'admin@cow.com',
          messages: [
            {
              content: 'Ch√†o Admin! Platform n√†y tuy·ªát v·ªùi qu√°! üéâ',
              timestamp: new Date('2025-08-03T09:00:00Z'),
              sender: 'sarah'
            },
            {
              content: 'C·∫£m ∆°n Sarah! Hy v·ªçng b·∫°n s·∫Ω chia s·∫ª nhi·ªÅu ·∫£nh ƒë·∫πp n·ªØa! üì∏',
              timestamp: new Date('2025-08-03T09:05:00Z'),
              sender: 'recipient'
            }
          ]
        }
      ],
      notifications: [
        {
          type: 'comment',
          message: 'Admin ƒë√£ b√¨nh lu·∫≠n v·ªÅ b√†i vi·∫øt c·ªßa b·∫°n',
          fromUser: 'admin@cow.com',
          read: false,
          data: { postIndex: 0, comment: 'H·ªôi An th·∫≠t tuy·ªát! ·∫¢nh ƒë·∫πp qu√°! üì∏' }
        }
      ]
    }
  ];
  
  return userData;
};

// Save organized data to database
const saveToDatabase = async (userData) => {
  console.log('üíæ Saving organized data to database...');
  
  const createdUsers = [];
  const userEmailToId = {};
  
  // First pass: Create all users
  for (const userInfo of userData) {
    const { profile } = userInfo;
    
    const saltRounds = 12;
    const passwordHash = await bcrypt.hash(profile.password, saltRounds);
    
    const user = await User.create({
      firstName: profile.firstName,
      lastName: profile.lastName,
      email: profile.email,
      passwordHash: passwordHash,
      bio: profile.bio,
      location: profile.location,
      verified: profile.verified,
      avatar: profile.avatar,
      cover: profile.cover,
      settings: profile.settings,
      createdAt: profile.joinDate
    });
    
    createdUsers.push(user);
    userEmailToId[profile.email] = user._id;
    
    console.log(`   ‚úÖ Created user: ${user.firstName} ${user.lastName} (${user.email})`);
  }
  
  // Second pass: Create posts for each user
  for (let i = 0; i < userData.length; i++) {
    const userInfo = userData[i];
    const user = createdUsers[i];
    
    for (const postData of userInfo.posts) {
      const post = await Post.create({
        content: postData.content,
        author: user._id,
        privacy: postData.privacy,
        tags: postData.tags,
        images: postData.images,
        location: postData.location
      });
      
      console.log(`   üìù Created post for ${user.firstName}: "${postData.content.substring(0, 50)}..."`);
    }
  }
  
  // Third pass: Create friendships
  for (let i = 0; i < userData.length; i++) {
    const userInfo = userData[i];
    const user = createdUsers[i];
    
    for (const friendEmail of userInfo.friends) {
      if (userEmailToId[friendEmail]) {
        try {
          await Friend.create({
            requester: user._id,
            recipient: userEmailToId[friendEmail],
            status: 'accepted',
            acceptedAt: new Date()
          });
          
          console.log(`   ü§ù Created friendship: ${user.firstName} <-> ${friendEmail}`);
        } catch (error) {
          // Friendship might already exist
        }
      }
    }
  }
  
  // Fourth pass: Create messages
  for (let i = 0; i < userData.length; i++) {
    const userInfo = userData[i];
    const user = createdUsers[i];
    
    for (const conversation of userInfo.conversations) {
      const recipientId = userEmailToId[conversation.with];
      if (recipientId) {        
        const conversationId = `${user._id}_${recipientId}`;
        
        for (const messageData of conversation.messages) {
          const senderId = messageData.sender === 'john' || messageData.sender === 'jane' || messageData.sender === 'sarah' || messageData.sender === 'admin' 
            ? user._id 
            : recipientId;
          
          await Message.create({
            sender: senderId,
            recipient: senderId === user._id ? recipientId : user._id,
            content: messageData.content,
            conversationId: conversationId,
            createdAt: messageData.timestamp
          });
          
          console.log(`   üí¨ Created message in conversation ${user.firstName} <-> ${conversation.with}`);
        }
      }
    }
  }
  
  // Fifth pass: Create notifications
  for (let i = 0; i < userData.length; i++) {
    const userInfo = userData[i];
    const user = createdUsers[i];
    
    for (const notificationData of userInfo.notifications) {
      const fromUserId = notificationData.fromUser ? userEmailToId[notificationData.fromUser] : null;
      
      await Notification.create({
        userId: user._id,
        fromUserId: fromUserId,
        type: notificationData.type,
        message: notificationData.message,
        read: notificationData.read,
        data: notificationData.data
      });
      
      console.log(`   üîî Created notification for ${user.firstName}`);
    }
  }
  
  return createdUsers;
};

// Add interactions (likes, comments)
const addInteractions = async (users) => {
  console.log('üëç Adding realistic interactions...');
  
  // Get all posts
  const posts = await Post.find().populate('author');
  
  // Add likes
  for (const post of posts) {
    const randomUsers = users.filter(u => !u._id.equals(post.author._id))
                           .sort(() => 0.5 - Math.random())
                           .slice(0, Math.floor(Math.random() * 3) + 1);
    
    for (const user of randomUsers) {
      await post.addLike(user._id);
    }
    
    console.log(`   üëç Added ${randomUsers.length} likes to post by ${post.author.firstName}`);
  }
  
  // Add comments
  const comments = [
    'B√†i vi·∫øt hay qu√°! üëç',
    'C·∫£m ∆°n b·∫°n ƒë√£ chia s·∫ª! üòä',
    'Th√¥ng tin r·∫•t h·ªØu √≠ch!',
    'Amazing content! üî•',
    'Keep it up! üí™',
    'Tuy·ªát v·ªùi! üéâ',
    'Very inspiring! ‚ú®',
    'Learnt something new today! üìö'
  ];
  
  for (const post of posts) {
    const numComments = Math.floor(Math.random() * 3);
    const randomUsers = users.filter(u => !u._id.equals(post.author._id))
                           .sort(() => 0.5 - Math.random())
                           .slice(0, numComments);
    
    for (const user of randomUsers) {
      const randomComment = comments[Math.floor(Math.random() * comments.length)];
      await post.addComment(user._id, randomComment);
    }
    
    if (numComments > 0) {
      console.log(`   üí¨ Added ${numComments} comments to post by ${post.author.firstName}`);
    }
  }
};

// Main function
const reorganizeUserData = async () => {
  try {
    console.log('üöÄ Starting user data reorganization...\n');
    
    await connectDB();
    
    console.log('‚ö†Ô∏è  WARNING: This will reorganize ALL user data!');
    console.log('Each user will have their own organized data structure.');
    console.log('Press Ctrl+C to cancel, or wait 5 seconds to continue...\n');
    
    await new Promise(resolve => setTimeout(resolve, 5000));
    
    await clearDatabase();
    console.log('');
    
    const userData = await createOrganizedUserData();
    console.log('');
    
    const users = await saveToDatabase(userData);
    console.log('');
    
    await addInteractions(users);
    console.log('');
    
    console.log('‚úÖ User data reorganization completed successfully!');
    console.log('\nüìä Organized Data Structure:');
    console.log('   üë§ Each user has complete profile information');
    console.log('   üìù Posts are linked to specific users');
    console.log('   ü§ù Friend relationships are properly mapped');
    console.log('   üí¨ Conversations show clear message threads');
    console.log('   üîî Notifications are user-specific');
    console.log('   ‚öôÔ∏è  User settings and preferences included');
    
    console.log('\nüîë Login credentials remain the same:');
    console.log('   üìß admin@cow.com / admin123 (Admin)');
    console.log('   üìß john@example.com / 123456 (Developer)');
    console.log('   üìß jane@example.com / 123456 (Designer)');
    console.log('   üìß mike@example.com / 123456 (Marketer)');
    console.log('   üìß sarah@example.com / 123456 (Photographer)');
    
    console.log('\nüéØ Benefits of this organization:');
    console.log('   ‚úÖ Easy user content management');
    console.log('   ‚úÖ Clear data ownership');
    console.log('   ‚úÖ Realistic user interactions');
    console.log('   ‚úÖ Professional user profiles');
    console.log('   ‚úÖ Organized conversation threads');
    
  } catch (error) {
    console.error('‚ùå Data reorganization failed:', error);
  } finally {
    mongoose.connection.close();
    console.log('\nüîå Database connection closed');
    process.exit(0);
  }
};

// Run reorganization
reorganizeUserData();
